<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.108.0">


<title>How to set up a Linux server to host git with LFS behind a VPN - ./gibson.sh --blog</title>
<meta property="og:title" content="How to set up a Linux server to host git with LFS behind a VPN - ./gibson.sh --blog">
<meta property="og:type" content="summary" />
<meta property="og:description" content="
This Howto explains how to set up a Linux server that runs SSH,
WireGuard VPN, Forgejo (a fork of
Gitea, a web-based git forge, kinda like self-hosted Github) and a minimal
DNS server so we can have an internal domain for pretty URLs.
We&rsquo;ll also set up automated backups and some basic self-monitoring.
To follow it you&rsquo;ll need (very) basic Linux commandline knowledge, i.e. you should be able to navigate
the file system in a terminal, use SSH and edit textfiles with a terminal-based text editor (like nano,
joe or vim, whatever you prefer).
It will assume that you&rsquo;re using Ubuntu Server 22.04, but it should be the same for other
(systemd-using) Debian-based Linux distributions, and reasonably similar when using other distributions.
You&rsquo;ll also need full root privileges on the system.
Hopefully this Howto is also useful if you only want to do some of these things (maybe set up
a public Forgejo instance, or just a Wireguard server without Forgejo on it)." />

<meta name="twitter:creator" content="@Doomed_Daniel" />
<meta property="og:image" content="http://blog.gibson.sh/images/logo-160.png" />

<link rel="me" href="https://mastodon.gamedev.place/@Doomed_Daniel" />



<link rel="stylesheet" href="../../../../css/main.css" media="all" />
<link rel="stylesheet" href="../../../../css/fonts.css" />


  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="../../../../" class="nav-logo" title="Home">
    <img src="../../../../images/logo.png"
        alt="Home" >
  </a>

  <ul class="nav-links">
    <li><b><a href="../../../../">Home</a></b></li>
    
    <li><a href="../../../../about/">About</a></li>
    
    <li><a href="https://github.com/DanielGibson/">Github</a></li>
    
    <li><a href="https://mastodon.gamedev.place/@Doomed_Daniel">Mastodon</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    

    <h1 class="article-title">How to set up a Linux server to host git with LFS behind a VPN</h1>

    
    <span class="article-date">May 26, 2023</span>
    

    <br>
    <div class="toc">
      <b>Table of Contents:</b>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#motivation">Motivation</a></li>
    <li><a href="#configuring-ssh-for-public-key-authentication">Configuring SSH for public key authentication</a>
      <ul>
        <li><a href="#1-use-your-default-ssh-key">1. Use your default SSH key</a></li>
        <li><a href="#2-creating-one-for-this-server">2. Creating one for this server</a></li>
        <li><a href="#enabling-your-public-ssh-key-on-the-server">Enabling your public SSH key on the server</a></li>
        <li><a href="#disable-ssh-login-with-password">Disable SSH login with password</a></li>
      </ul>
    </li>
    <li><a href="#setting-up-a-wireguard-vpn-server">Setting up a WireGuard VPN server</a>
      <ul>
        <li><a href="#install-wireguard">Install WireGuard</a></li>
        <li><a href="#basic-setup-of-the-server">Basic setup of the server</a></li>
        <li><a href="#configure-a-new-client-on-the-client">Configure a new client, on the client</a>
          <ul>
            <li><a href="#on-windows">&hellip; on Windows</a></li>
            <li><a href="#on-linux-and-similar-using-wg-quick">&hellip; on Linux and similar (using wg-quick)</a></li>
            <li><a href="#on-macos">&hellip; on macOS</a></li>
          </ul>
        </li>
        <li><a href="#add-new-clients-to-the-server-configuration">Add new clients to the server configuration</a></li>
        <li><a href="#configure-the-server-to-automatically-start-the-connection">Configure the server to automatically start the connection</a></li>
      </ul>
    </li>
    <li><a href="#a-simple-firewall-with-iptables-and-sshguard">A simple firewall with iptables and SSHGuard</a></li>
    <li><a href="#setting-up-dnsmasq-as-dns-server-for-a-local-domain">Setting up dnsmasq as DNS server for a local domain</a>
      <ul>
        <li><a href="#configure-clients-to-use-the-dns-server">Configure clients to use the DNS server</a>
          <ul>
            <li><a href="#linux-and-other-unix-likes">Linux and other Unix-likes</a></li>
            <li><a href="#windows">Windows</a></li>
            <li><a href="#macos">macOS</a></li>
            <li><a href="#testing-the-dns-server">Testing the DNS server</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#setting-up-nginx-as-a-reverse-http-proxy">Setting up nginx as a reverse http proxy</a></li>
    <li><a href="#setting-up-dma-as-sendmail-implementation">Setting up dma as sendmail implementation</a>
      <ul>
        <li><a href="#testing-the-sendmail-command">Testing the sendmail command</a></li>
        <li><a href="#redirect-local-mails-for-root-to-your-mail-account">Redirect local mails for root to your mail account</a></li>
      </ul>
    </li>
    <li><a href="#setting-up-forgejo-for-git-hosting">Setting up Forgejo for git hosting</a>
      <ul>
        <li><a href="#install-forgejo-and-git-create-git-user">Install Forgejo and git, create git user</a></li>
        <li><a href="#create-directories-forgejo-will-use">Create directories Forgejo will use</a></li>
        <li><a href="#optional-set-up-database">Optional: Set up database</a></li>
        <li><a href="#install-systemd-service-for-forgejo">Install systemd service for Forgejo</a></li>
        <li><a href="#forgejos-web-based-configuration">Forgejos web-based configuration</a></li>
        <li><a href="#further-configuration-in-forgejos-app-ini">Further configuration in Forgejos app.ini</a></li>
        <li><a href="#general-hints-for-using-forgejo">General hints for using Forgejo</a></li>
        <li><a href="#local-storage-vs-object-storage-for-lfs">Local storage vs. object storage for LFS</a>
          <ul>
            <li><a href="#migrating-to-from-object-storage">Migrating to/from object-storage</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#backups-with-restic">Backups with restic</a>
      <ul>
        <li><a href="#installing-restic">Installing restic</a></li>
        <li><a href="#optional-install-and-configure-rclone">Optional: Install and configure Rclone</a></li>
        <li><a href="#setting-up-a-new-restic-backup-repository">Setting up a new restic backup repository</a></li>
        <li><a href="#actually-backing-up">Actually backing up</a></li>
        <li><a href="#create-a-cronjob-to-do-a-backup-every-night">Create a cronjob to do a backup every night</a></li>
        <li><a href="#some-more-notes-on-restic">Some more notes on restic</a></li>
        <li><a href="#backing-up-the-backup">Backing up the backup</a></li>
      </ul>
    </li>
    <li><a href="#keeping-the-server-updated">Keeping the server updated</a>
      <ul>
        <li><a href="#apticron-send-mail-if-updates-are-available">apticron - send mail if updates are available</a></li>
        <li><a href="#unattended-upgrades-install-security-updates-automatically">unattended-upgrades - install security updates automatically</a></li>
      </ul>
    </li>
    <li><a href="#some-basic-monitoring">Some basic monitoring</a></li>
    <li><a href="#bonus-openproject">Bonus: OpenProject</a></li>
    <li><a href="#thanks">Thanks</a></li>
  </ul>
</nav>
    </div>

    <div class="article-content">
      <!-- # How to set up a Linux server to host git with LFS behind a VPN -->
<p>This Howto explains how to set up a Linux server that runs <a href="https://www.openssh.com/">SSH</a>,
<a href="https://www.wireguard.com/">WireGuard VPN</a>, <a href="https://forgejo.org/">Forgejo</a> (a fork of
<a href="https://gitea.io">Gitea</a>, a web-based git forge, kinda like self-hosted Github) and a minimal
<a href="https://thekelleys.org.uk/dnsmasq/doc.html">DNS server</a> so we can have an internal domain for pretty URLs.
We&rsquo;ll also set up automated backups and some basic self-monitoring.<br>
To follow it <strong>you&rsquo;ll need (very) basic Linux commandline knowledge</strong>, i.e. you should be able to navigate
the file system in a terminal, use SSH and edit textfiles with a terminal-based text editor (like nano,
joe or vim, whatever you prefer).<br>
It will assume that you&rsquo;re using <strong>Ubuntu Server 22.04</strong>, but it should be the same for other
(systemd-using) Debian-based Linux distributions, and reasonably similar when using other distributions.
You&rsquo;ll also need full <strong>root privileges</strong> on the system.</p>
<p>Hopefully this Howto is also useful if you only want to do some of these things (maybe set up
a public Forgejo instance, or just a Wireguard server without Forgejo on it).</p>
<p><strong>Note:</strong> You&rsquo;ll often need to enter commands in the shell. The following convention will be used:</p>
<p><code>$ some_command --some argument</code><br>
means: Enter &ldquo;some_command --some argument&rdquo; (without quotes) in a Linux terminal, <em>as <strong>normal user</strong></em>.</p>
<p><code># some_command --some argument</code><br>
means: Enter &ldquo;some_command --some argument&rdquo; (without quotes) in a Linux terminal, <em>as <strong>root</strong></em>,
or maybe with <code>sudo</code> (you can use <code>$ sudo -i</code> to get a root-shell so you don&rsquo;t have to use sudo
for each command).</p>
<h1 id="motivation">Motivation</h1>
<p><em>You can skip this section if you&rsquo;re already convinced that this Howto is relevant for you ;-)</em></p>
<p><a href="https://www.masterbrainbytes.com/">We</a> needed a git server with a web frontend.
It should be low-maintenance, because we&rsquo;re a small company that doesn&rsquo;t have a dedicated admin who
could regularly spend time on keeping the server up-to-date, especially when running external
software packages where updates might require more steps than a <code>sudo apt update &amp;&amp; sudo apt upgrade</code>.</p>
<p>To be honest, we <em>would</em> probably just pay a service like Github or Gitlab or whatever, if they had
offers that meet our requirements at a reasonable price - but we create games (and related products),
which means we don&rsquo;t only have code, but also <em>lots</em> of binary data (game assets like models and textures),
even relatively small projects can easily have checkout sizes (<em>without history!</em>) of dozens of GB,
bigger projects often use several hundreds of GB or more. Nowadays Git supports that reasonably well with
<a href="https://git-lfs.com/">Git Large File Storage (LFS)</a>, and while several Git hosters generally support LFS,
prices for data are a bit high: Gitlab&rsquo;s takes $60/month for packs of 10GB of storage and 20GB
of traffic.. Githubs prices are a bit less ridiculous with &ldquo;data packs&rdquo; that cost $5/month
for 50GB of data and 50GB of traffic, but if you have a 40GB repo you&rsquo;ll already need a second
data pack if you do more than one full clone per month.. this doesn&rsquo;t scale that well.<br>
So self-hosting is a lot more attractive, as you can get a VPS (Virtual Private Server,
basically a VM running &ldquo;in the cloud&rdquo;) with several hundreds of GB storage for &lt; €20/month,
and S3-style &ldquo;object storage&rdquo; (that can be used for Git LFS data) for about €10 per 1TB per month<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</p>
<p>To <strong>host Git</strong> (and get a nice Github-ish frontend) we use <a href="https://forgejo.org/">Forgejo</a>, a fork
of <a href="https://gitea.io/">Gitea</a>. It&rsquo;s written in Go and is just a single executable with few external
dependencies (it needs a database, but supports <a href="https://sqlite.org/index.html">sqlite</a>, which should
be good enough for up to at least 10 users<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>). It can store the LFS data directly in the filesystem
on the servers disk, but also supports storing it in S3-compatible (external) object storage.</p>
<p>We work decentralized, most people at home, so the server needs to be accessible over the
internet.<br>
However, to keep <strong>maintenance</strong> low (while maintaining reasonable security), we &ldquo;hide&rdquo; Forgejo
behind a <a href="https://www.wireguard.com/">Wireguard</a> VPN, so:</p>
<ol>
<li>The only network ports open to the internet are those of Wireguard and SSH, which both are installed
from the standard distro packages (and thus can be easily updated) and are known to have good security
<em>(arguably I could also hide SSH behind Wireguard, but I&rsquo;d like to be able to get on the server
with SSH directly even if Wireguard should fail for some reason. I&rsquo;ll make SSH public-key-auth-only,
so I don&rsquo;t have to worry about bruteforcing attacks on the user passwords)</em>.</li>
<li>This means that we don&rsquo;t have to worry that Forgejo might have a vulnerability that allows
unauthenticated users to run code (Gitlab
<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22205">had such an issue a few years back</a>),
because only our team can access it at all, so if we forget to update Forgejo for a while,
we&rsquo;ll still be safe<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>.</li>
<li>We can use plain HTTP (instead of HTTPS), because all connections to Forgejo go through the
encrypted Wireguard tunnel, so we don&rsquo;t have to mess around with SSL certificates.</li>
</ol>
<p>And of course, if we need other web-based services (like maybe a fancier bugtracker) those can be
run and protected in the same way.</p>
<h1 id="configuring-ssh-for-public-key-authentication">Configuring SSH for public key authentication</h1>
<p>If you rent a (virtual private) server with Linux, you&rsquo;ll most probably get SSH access, likely with
a password.<br>
It&rsquo;s more secure (and possibly more comfortable) to use SSH public key authentication (which is also
what&rsquo;s usually used with Git). For this a cryptographic key-pair, consisting of a private and a public key,
is generated on clients (like the computer you&rsquo;re using) that should be able to connect to the server
with SSH</p>
<p>Here you&rsquo;ve got two options: Using your default SSH key, or creating one specifically for this server.</p>
<h2 id="1-use-your-default-ssh-key">1. Use your default SSH key</h2>
<p>Check if you already have a default SSH public key, it&rsquo;s in <code>$HOME/.ssh/id_rsa.pub</code> (on Windows
<code>C:\Users\YourUserName\.ssh\id_rsa.pub</code>, on Linux something like <code>/home/yourusername/.ssh/id_rsa.pub</code>).</p>
<p>If not, you can create it by running<br>
<code>$ ssh-keygen</code><br>
in a terminal. Confirm that you want to save
it in the default place (which should be the one mentioned above) and enter a password that will
be used to <em>locally</em> decrypt the key, for extra security.</p>
<p>When connecting to a SSH service that has public key authentication enabled, it will be used by default.
You might be asked for the password <em>of your SSH key</em> then, which is the one you set in <code>ssh-keygen</code>.</p>
<h2 id="2-creating-one-for-this-server">2. Creating one for this server</h2>
<p>You can create an SSH key pair just for this server, possibly with a different password than the one
you&rsquo;re using for your default SSH key.</p>
<p>To do this, just run:<br>
<code>$ ssh-keygen -f /path/to/keyfile</code><br>
This will create <code>/path/to/keyfile</code> (private key) and <code>/path/to/keyfile.pub</code> (public key).</p>
<p>You&rsquo;ll have to tell the SSH client to use this keyfile with <code>ssh -i /path/to/keyfile example-host.com</code><br>
&hellip; <strong>or</strong> you create an entry in <code>$HOME/.ssh/config</code> for the host:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># my VPS for hosting git</span>
</span></span><span class="line"><span class="cl">Host example-host.com
</span></span><span class="line"><span class="cl">    <span class="c1"># or whatever user you&#39;re using for logging in</span>
</span></span><span class="line"><span class="cl">    User root
</span></span><span class="line"><span class="cl">    HostName example-host.com
</span></span><span class="line"><span class="cl">    IdentityFile /path/to/keyfile
</span></span></code></pre></div><p>then <code>$ ssh example-host.com</code> will automatically set the username and the keyfile</p>
<h2 id="enabling-your-public-ssh-key-on-the-server">Enabling your public SSH key on the server</h2>
<p>Of course you need to tell the server your SSH public key so it can use it to authenticate your
connections. To do this, <strong>on the server</strong> edit the file <code>$HOME/.ssh/authorized_keys</code> (create it if
it doesn&rsquo;t exist) and add a line with the contents or the public key file from your local machine
(<code>$HOME/.ssh/id_rsa.pub</code> or <code>/path/to/keyfile.pub</code>).</p>
<p>Verify that this works by logging out of the server and logging in again (if you&rsquo;re using an SSH
key specific to this server, remember to pass the <code>-i /path/to/key</code> option to SSH).
It should ask for a password <strong>for the key file</strong>, like <code>Enter password for key '/path/to/keyfile':</code>,
<em>not</em> for the host (that prompt would look like <code>username@host password:</code>). Enter the password you
chose when creating the key file and you should be on the server.</p>
<p>If this didn&rsquo;t work as expected, you&rsquo;ll have to debug and fix that problem.</p>
<p>Once it works go on with the next step:</p>
<h2 id="disable-ssh-login-with-password">Disable SSH login with password</h2>
<p>Now that you can log into the server with public key authentication, logging in with a password
can be disabled, to prevent attackers from bruteforcing the password.</p>
<blockquote>
<p><strong>NOTE:</strong> <em>If your server hoster supports creating <strong>snapshots</strong> of the server, now would be
a good time to take one, so you can just restore it in case anything goes wrong here and you can&rsquo;t
log in anymore (shouldn&rsquo;t happen if this is done correctly and you verified that logging in with
public key authentication works, but better safe than sorry).</em></p>
</blockquote>
<p>As root (or with <code>sudo</code>) edit <code>/etc/ssh/sshd_config</code> and search for a line that contains
&ldquo;PasswordAuthentication&rdquo; and change it to <code>PasswordAuthentication no</code> - make sure to remove any <code>#</code>
characters from the start of the line as they comment it out!<br>
If there is no line with &ldquo;PasswordAuthentication&rdquo; yet, just add the <code>PasswordAuthentication no</code> line
somewhere in the middle of the config, <em>before</em> any lines that start with &ldquo;Match&rdquo;, like &ldquo;Match user asfd&rdquo;.<br>
Do the same to ensure that a <code>ChallengeResponseAuthentication no</code> line exists.</p>
<p>Save the file and restart the SSH server to make sure the changed config is loaded:<br>
<code># systemctl restart sshd</code></p>
<p>If that failed for some reason, <code>systemctl status sshd</code> should show some information on the cause.</p>
<h1 id="setting-up-a-wireguard-vpn-server">Setting up a WireGuard VPN server</h1>
<h2 id="install-wireguard">Install WireGuard</h2>
<p><code># apt install wireguard-tools</code></p>
<p>If the Linux kernel you&rsquo;re using is older than 5.6 (check with <code>$ uname -r</code>), also install <code>wireguard-dkms</code>
to get the WireGuard kernel module (it&rsquo;s included in Linux 5.6 and newer).</p>
<h2 id="basic-setup-of-the-server">Basic setup of the server</h2>
<blockquote>
<p><strong>NOTE:</strong> This is a quite basic configuration of WireGuard, suitable for this particular usecase.
It fully supports IPv6 (but here having IPv4 addresses in the VPN is sufficient) and
can be configured in other ways than the classic &ldquo;one VPN server with several clients&rdquo; scenario
used here.<br>
If you&rsquo;ve already got a wireguard connection <code>wg0</code> configured, just give it another name
like <code>wg1</code>, so whenever this Howto mentions <code>wg0</code>, use <code>wg1</code> instead.</p>
</blockquote>
<p>Wireguard requires a private and corresponding public key for the server (and also
for each client, we&rsquo;ll get to that later).<br>
Create a directory that only root can access to store them in:<br>
<code># mkdir /root/wireguard &amp;&amp; chmod 700 /root/wireguard</code><br>
<code># cd /root/wireguard &amp;&amp; umask 077</code></p>
<p>Now use WireGuards <code>wg</code> tool with the <code>genkey</code> command to generate a new private key
(stored it in a file called <code>wg_privatekey.txt</code>):<br>
<code># wg genkey &gt; wg_privatekey.txt</code><br>
and the <code>pubkey</code> command to generate the public key (<code>wg_publickey.txt</code>) from the private key:<br>
<code># cat wg_privatekey.txt | wg pubkey &gt; wg_publickey.txt</code></p>
<p>The easiest way to set up a WireGuard network device (here it&rsquo;s called <code>wg0</code>) is creating a config
for the <code>wg-quick</code> tool.<br>
As root create a textfile at <code>/etc/wireguard/wg0.conf</code> with the following content:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="c1"># configuration of this server (its IP in the VPN, what port to listen on etc)</span>
</span></span><span class="line"><span class="cl"><span class="k">[Interface]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the private IP the server will have in the VPN and its subnet (e.g. /24)</span>
</span></span><span class="line"><span class="cl"><span class="na">Address</span> <span class="o">=</span> <span class="s">172.30.0.1/24</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the UDP port wireguard will listen on - 51820 is WireGuards default port</span>
</span></span><span class="line"><span class="cl"><span class="na">ListenPort</span> <span class="o">=</span> <span class="s">51820</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the servers private key</span>
</span></span><span class="line"><span class="cl"><span class="c1"># replace &#34;YourPrivateKey&#34; with the private key stored in wg_privatekey.txt</span>
</span></span><span class="line"><span class="cl"><span class="na">PrivateKey</span> <span class="o">=</span> <span class="s">YourPrivateKey</span>
</span></span></code></pre></div><blockquote>
<p><strong>NOTE:</strong> In WireGuard configurations (and lots of other kinds of config files and scripts),
lines starting with <code>#</code> are comments. They&rsquo;re ignored by WireGuard and are meant to provide
information to humans reading those files. In this case that&rsquo;s you, or other people who might
want to modify your WireGuard configs later.</p>
</blockquote>
<p>Make sure it&rsquo;s only readable by root (it contains your private key, after all!):<br>
<code># chmod 600 /etc/wireguard/wg0.conf</code></p>
<p><strong><code>Address</code></strong> should be a
<a href="https://en.wikipedia.org/wiki/Internet_Protocol_version_4#Private_networks">private IPv4 address</a>
that doesn&rsquo;t conflict with your LAN/WIFI at home, in the office or wherever this is going to be used.
<code>/24</code> at the end of the IP is the subnet mask of the network we&rsquo;re creating (equivalent to
<code>255.255.255.0</code>), meaning we can have up to 254 different IPs in the VPN (in this case 172.30.0.1
to 172.30.0.254; the first and last IPs - 172.30.0.0 and 172.30.0.255 in this example - have special
meanings); see <a href="https://en.wikipedia.org/wiki/Subnetwork">Wikipedia (Subnetwork)</a> for details.
Of course you could choose a different IP and subnetwork, including one that&rsquo;s bigger (like a /20),
whatever suits your needs.</p>
<p>This is enough to get the wireguard network interface up:<br>
<code># wg-quick up wg0</code><br>
creates a WireGuard interface <strong>wg0</strong> based on the settings in /etc/wireguard/<strong>wg0</strong>.conf.<br>
You can verify that it worked with:<br>
<code># ip address show wg0</code><br>
the output should look like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">3: wg0: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt; mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000
</span></span><span class="line"><span class="cl">    link/none 
</span></span><span class="line"><span class="cl">    inet 172.30.0.1/24 scope global wg0
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>That&rsquo;s a good start, but so far no one will be able to connect to this server, as no clients have
been configured yet.</p>
<h2 id="configure-a-new-client-on-the-client">Configure a new client, on the client</h2>
<p>This must be done on the client machine that&rsquo;s supposed to connect to the server!</p>
<p>This is similar to the server configuration. First you&rsquo;ll need to install wireguard, of course,
see <a href="https://www.wireguard.com/install/">the WireGuard Installation page</a> for installers for several
operating systems including Windows.</p>
<h3 id="on-windows">&hellip; on Windows</h3>
<p>Start the WireGuard application, or right-click the wireguard icon next to the clock of your taskbar
and select &ldquo;Manage tunnels&hellip;&rdquo;</p>
<p>Then add an empty VPN tunnel:<br>
<img src="../../../../images/wireguard_emptytunnel.png" alt="Add empty tunnel"></p>
<p>And configure it:<br>
<img src="../../../../images/wireguard_tunnelconf.png" alt="Configure tunnel"></p>
<p>A new PrivateKey is automatically generated and set (and the PublicKey is set from it),
but you&rsquo;ll have to add the other settings shown on the screenshot (of course adjusted to your needs).
For <strong>Name</strong>, just pick a sensible name. Or a nonsensical one, I don&rsquo;t care :-p<br>
See the Linux section below for more explanation of the other settings.</p>
<p>Note that you&rsquo;ll need the <strong>Public Key</strong> later, so you can already copy it somewhere.</p>
<p>Click <code>Save</code>. You can&rsquo;t activate the connection yet though, this new client must first be added
to the server configuration, see below.</p>
<h3 id="on-linux-and-similar-using-wg-quick">&hellip; on Linux and similar (using wg-quick)</h3>
<p>Like on the server, create a <code>/root/wireguard/</code> directory, make sure only root can access it and
create a private and a public WireGuard key:<br>
<code># mkdir /root/wireguard &amp;&amp; chmod 700 /root/wireguard</code><br>
<code># cd /root/wireguard &amp;&amp; umask 077</code><br>
<code># wg genkey &gt; wg_privatekey.txt</code><br>
<code># cat wg_privatekey.txt | wg pubkey &gt; wg_publickey.txt</code></p>
<p>Create <code>/etc/wireguard/wg0.conf</code> on the client with the following contents:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="c1"># settings for this interface </span>
</span></span><span class="line"><span class="cl"><span class="k">[Interface]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># this client&#39;s private key</span>
</span></span><span class="line"><span class="cl"><span class="na">PrivateKey</span> <span class="o">=</span> <span class="s">ThisClientsPrivateKey</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the IP address this client will use in the private network</span>
</span></span><span class="line"><span class="cl"><span class="c1"># must not be used by another client (or the server itself)</span>
</span></span><span class="line"><span class="cl"><span class="na">Address</span> <span class="o">=</span> <span class="s">172.30.0.3/24</span>
</span></span><span class="line"><span class="cl"><span class="c1"># configure a DNS server for a custom local domain</span>
</span></span><span class="line"><span class="cl"><span class="c1"># only relevant on Linux, will be set in a later chapter</span>
</span></span><span class="line"><span class="cl"><span class="c1">#PostUp = TODO</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># the server we&#39;re gonna connect to</span>
</span></span><span class="line"><span class="cl"><span class="k">[Peer]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># public key of the *server*</span>
</span></span><span class="line"><span class="cl"><span class="na">PublicKey</span> <span class="o">=</span> <span class="s">YourServersPublicKey</span>
</span></span><span class="line"><span class="cl"><span class="c1"># AllowedIPs is used for routing (only) that network through the tunnel</span>
</span></span><span class="line"><span class="cl"><span class="na">AllowedIPs</span> <span class="o">=</span> <span class="s">172.30.0.0/24</span>
</span></span><span class="line"><span class="cl"><span class="c1"># public IP or domain of the server and the port it&#39;s listening on</span>
</span></span><span class="line"><span class="cl"><span class="na">Endpoint</span> <span class="o">=</span> <span class="s">yourserver.example.net:51820</span>
</span></span></code></pre></div><ul>
<li>The <strong><code>[Interface]</code></strong> section configures the WireGuard network interface of this client.
It has the following settings:
<ul>
<li><strong>PrivateKey</strong> is the private key <strong>of this client</strong>. On Windows this line is generated
automatically, on Linux use the private key you just generated (in
<code>/root/wireguard/wg_privatekey.txt</code> on the client).</li>
<li><strong>Address</strong> must be an unused address in the private network you configured as &ldquo;Address&rdquo;
on the server.
<strong>Note</strong> that it must have the <strong>same subnetmask</strong>, <code>/24</code> in my example.</li>
<li><strong>PostUp</strong>  lets you set a command that&rsquo;s executed when the connection is established.
Not available on Windows (unless explicitly allowing it in the registry).<br>
Commented out for now because it only makes sense after the DNS chapter below.</li>
</ul>
</li>
<li>The <strong><code>[Peer]</code></strong> section configures the server this client will connect to:
<ul>
<li><strong>PublicKey</strong> is the public key of the server, if you followed the instructions
above it&rsquo;s saved in <code>/root/wireguard/wg_publickey.txt</code> <strong>on the server</strong>, so replace
&ldquo;YourServersPublicKey&rdquo; with the contents of that file.</li>
<li><strong>AllowedIPs</strong> is the private network reachable through this tunnel, note that it uses
<code>172.30.0.0</code> as IP (the first IP of the subnet), which has the special meaning of representing
that subnet. Used by WireGuard to ensure that only IPs in that network are routed through
the tunnel.</li>
<li><strong>EndPoint</strong> configures the public address and port of the WireGuard server that the client
connects to. Replace &ldquo;yourserver.example.net&rdquo; (or &ldquo;1.2.3.4&rdquo;) with the correct IP or domain.</li>
</ul>
</li>
</ul>
<p>Now the VPN connection is configured on the client, but won&rsquo;t work just yet, because the server
must be told about the new client first.</p>
<blockquote>
<p><strong>NOTE:</strong> As the administrator of the WireGuard server, it make sense to have a copy of a
client configuration in a local text file, <strong>without the PrivateKey</strong>, as a template for future
clients - the only things that must be adjusted per client are the <strong>PrivateKey</strong> and the <strong>Address</strong>
(I also replace the last part of the  <strong>Address</strong> IP with <code>TODO</code> to make sure I don&rsquo;t forget to
set a new IP when copy&amp;pasting it to a new client configuration).</p>
</blockquote>
<h3 id="on-macos">&hellip; on macOS</h3>
<p>No idea, I don&rsquo;t have a mac :-p</p>
<p>There seems to be a WireGuard App in the <a href="https://apps.apple.com/de/app/wireguard/id1451685025?mt=12">App Store</a>
and looking at <a href="https://docs.oakhost.net/tutorials/wireguard-macos-server-vpn/#configuring-the-client">this tutorial</a>
I found it seems to be pretty similar to the Windows one, so you should be able to get it to work :-)</p>
<h2 id="add-new-clients-to-the-server-configuration">Add new clients to the server configuration</h2>
<p>On the <strong>server</strong>, open <code>/etc/wireguard/wg0.conf</code> in a text editor (as root).</p>
<p>At the end of the file, add the following (this example adds two clients, if you only created one,
add only one <code>[Peer]</code> section):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">### List of clients that can connect to the VPN ###</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Heinrichs Windows PC</span>
</span></span><span class="line"><span class="cl"><span class="k">[Peer]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># replace with the real public key of the client</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (copied from the clients tunnel configuration)</span>
</span></span><span class="line"><span class="cl"><span class="na">PublicKey</span> <span class="o">=</span> <span class="s">bsiSrU3tPnu2j5qbtc+00nemvHAqClxBbyaam8=</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the IP the client gets, must be the same as in the &#34;Address&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># in the clients config !! but with /32 at the end !!</span>
</span></span><span class="line"><span class="cl"><span class="na">AllowedIPs</span> <span class="o">=</span> <span class="s">172.30.0.2/32</span>
</span></span><span class="line"><span class="cl"><span class="c1"># make sure the connection stays alive, esp. if NAT routers are involved</span>
</span></span><span class="line"><span class="cl"><span class="na">PersistentKeepalive</span> <span class="o">=</span> <span class="s">21</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Daniels Linux Laptop</span>
</span></span><span class="line"><span class="cl"><span class="k">[Peer]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># replace &#34;DanielsPublicKey&#34; with the public key of the client</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (from the clients wg_publickey.txt)</span>
</span></span><span class="line"><span class="cl"><span class="na">PublicKey</span> <span class="o">=</span> <span class="s">DanielsPublicKey</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the IP the client gets, must be the same as in the &#34;Address&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># in the clients config !! but with /32 at the end !!</span>
</span></span><span class="line"><span class="cl"><span class="na">AllowedIPs</span> <span class="o">=</span> <span class="s">172.30.0.3/32</span>
</span></span><span class="line"><span class="cl"><span class="c1"># make sure the connection stays alive, esp. if NAT routers are involved</span>
</span></span><span class="line"><span class="cl"><span class="na">PersistentKeepalive</span> <span class="o">=</span> <span class="s">21</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># TODO: add more clients in the future, make sure they all use different IPs</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       and that everyone has their own [Peer] section</span>
</span></span></code></pre></div><p><strong>Note</strong> that, unlike <em>on</em> the client, <strong>AllowedIPs</strong> must have <strong><code>/32</code></strong> as subnet mask
(meaning all bits are masked, i.e. it only refers to this one IP), because only
traffic for that IP should be routed to that particular client<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>.</p>
<p>Now you can tell WireGuard to reload the config:<br>
<code># wg syncconf wg0 &lt;(wg-quick strip wg0)</code></p>
<p>.. and now the clients should be able to connect (on Windows by clicking <code>Activate</code> for the tunnel,
on Linux with <code># wg-quick up wg0</code>).</p>
<p><strong>Note</strong> that clients can only communicate with the server, not with each other, at least without
setting up ip forwarding on the server (which isn&rsquo;t done here).</p>
<p><code>PersistentKeepalive = 21</code> makes sure that a (possibly empty) network packet is sent at least every
21 seconds to make sure that routers and firewalls between the client and the server don&rsquo;t assume
the WireGuard connection is closed when there&rsquo;s no real traffic, see also
<a href="https://www.wireguard.com/quickstart/#nat-and-firewall-traversal-persistence">this more elaborate explanation</a>.</p>
<blockquote>
<p><strong>NOTE:</strong> If you&rsquo;re wondering why the client and the server need to know <strong>each others public keys</strong>,
that&rsquo;s for security. When a WireGuard client connects to a WireGuard server, the server uses
its copies of the clients public keys to identify the client (make sure the client is allowed to
connect at all, and set client-specific options like their IP). The client on the other hand
uses its copy of the servers public key to make sure that the WireGuard server it&rsquo;s connecting to
really is the one it wants and not just an attacker who somehow redirected traffic meant for your
WireGuard server to a server controlled by the attacker. For the general concept, see also
<a href="https://en.wikipedia.org/wiki/Public-key_cryptography">Wikipedia on Public-key cryptography</a></p>
</blockquote>
<h2 id="configure-the-server-to-automatically-start-the-connection">Configure the server to automatically start the connection</h2>
<p>While you should have a working WireGuard VPN tunnel now, it won&rsquo;t work anymore if the server
is rebooted. So let&rsquo;s tell the server to automatically start the wireguard server.
Luckily the wireguard-tools Ubuntu package provides a systemd service that works with WireGuard
devices configured with a wg-quick config, so we don&rsquo;t have to do much.</p>
<p>To be sure there&rsquo;s no conflicts, first take the interface down:<br>
<code># wg-quick down wg0</code></p>
<p>Then enable the systemd service and start it:<br>
<code># systemctl enable wg-quick@wg0.service</code><br>
<code># systemctl start wg-quick@wg0.service</code></p>
<p>Check its state with:<br>
<code># systemctl status wg-quick@wg0.service</code></p>
<p>If you modify wg0.conf, instead of calling <code># wg syncconf wg0 &lt;(wg-quick strip wg0)</code> as shown above,
you can now also run:<br>
<code># systemctl reload wg-quick@wg0.service</code></p>
<blockquote>
<p><strong>NOTE:</strong> You could do the same on Linux <strong>clients</strong> of course, if you want to start the <code>wg0</code>
connection to the server automatically at boot.</p>
</blockquote>
<p>It might be a good idea to <strong>reboot the server</strong> and to make sure everything still works as expected
after the boot.</p>
<h1 id="a-simple-firewall-with-iptables-and-sshguard">A simple firewall with iptables and SSHGuard</h1>
<p>Before setting up any more services, let&rsquo;s create some simple firewall rules that block all
connection attempts from the internet, except for ones to SSH and WireGuard.<br>
Furthermore <a href="https://www.sshguard.net/">SSHGuard</a> is used to block hosts that are attacking our
SSH server.</p>
<p>Install SSHGuard and ipset:<br>
<code># apt install sshguard ipset</code></p>
<p><strong>Configure sshguard</strong> by editing <code>/etc/sshguard/sshguard.conf</code> (as root) and replace the
<code>BACKEND=...</code> line near the top of the file with<br>
<code>BACKEND=&quot;/usr/libexec/sshguard/sshg-fw-ipset&quot;</code><br>
so SSHGuard stores the IPs that should be blocked in an <a href="https://linux.die.net/man/8/ipset">ipset</a> that
can be used in iptables rules. Save the file, then restart SSHGuard so it applies the changed config:<br>
<code># systemctl restart sshguard.service</code></p>
<blockquote>
<p><strong>NOTE:</strong> <em>If your server hoster supports creating <strong>snapshots</strong> of the server, now would be
a good time to take one, so you can just restore it in case something goes wrong with the
firewall rules we&rsquo;re about to create and you lock yourself out</em></p>
</blockquote>
<p>By default, Ubuntu ships the <a href="https://help.ubuntu.com/community/UFW">UFW</a> firewall.
This Howto uses plain <a href="https://en.wikipedia.org/wiki/Iptables">ip(6)tables</a>, so disable ufw<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup>:<br>
<code># systemctl stop ufw.service</code><br>
<code># systemctl disable ufw.service</code></p>
<p>I suggest putting the firewall scripts into <code>/root/scripts/</code>, so create that directory.</p>
<p>Create one script called <code>firewall-flush.sh</code> in that directory that removes all firewall rules
and allows all connections:<br>
<a href="../../../../downloads/firewall-flush.sh" download>Download firewall-flush.sh</a></p>
<details> <summary>Click to show the script</summary>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># This script resets ip(6)tables so all connections are allowed again</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Flushing firewall (iptables) rules&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># flush (remove) all existing rules</span>
</span></span><span class="line"><span class="cl">iptables -F
</span></span><span class="line"><span class="cl">iptables -t nat -F
</span></span><span class="line"><span class="cl">iptables -t filter -F
</span></span><span class="line"><span class="cl">iptables -t mangle -F
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># set INPUT policy to ACCEPT again</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (otherwise it&#39;d remain at DROP and no connection would be possible)</span>
</span></span><span class="line"><span class="cl">iptables -P INPUT ACCEPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;.. same for IPv6 (ip6tables) ..&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># flush all existing rules</span>
</span></span><span class="line"><span class="cl">ip6tables -F
</span></span><span class="line"><span class="cl">ip6tables -t nat -F
</span></span><span class="line"><span class="cl">ip6tables -t filter -F
</span></span><span class="line"><span class="cl">ip6tables -t mangle -F
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># reset ip6tables INPUT policy to ACCEPT</span>
</span></span><span class="line"><span class="cl">ip6tables -P INPUT ACCEPT
</span></span></code></pre></div></details>
<p>Then create a second script <code>firewall.sh</code> with the actual firewall rules
(see the comments in the scripts for a little explanation of what it does).<br>
<strong>Note</strong> that you might have to modify the <code>WAN</code> network device name. It&rsquo;s the network device
connected to the internet - it might be called <code>eth0</code>, but names like <code>enp5s0</code> or similar
are also common. Just adjust the <code>WAN=&quot;eth0&quot;</code> line accordingly<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>.<br>
<code>firewall.sh</code>: <a href="../../../../downloads/firewall.sh" download>Download firewall.sh</a></p>
<details><summary>Click to show the script</summary>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># Daniels little firewall script</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Makes sure that we only accept SSH and wireguard connections</span>
</span></span><span class="line"><span class="cl"><span class="c1"># from the internet. All other services (like http for the git tool etc)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># are only allowed via wireguard VPN (dev wg0)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># the network device connected to the internet</span>
</span></span><span class="line"><span class="cl"><span class="nv">WAN</span><span class="o">=</span><span class="s2">&#34;eth0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the VPN device (for connections to services not publicly exposed)</span>
</span></span><span class="line"><span class="cl"><span class="nv">VPN</span><span class="o">=</span><span class="s2">&#34;wg0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Creating IPv4 (iptables) firewall rules..&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># flush all existing rules</span>
</span></span><span class="line"><span class="cl">iptables -F
</span></span><span class="line"><span class="cl">iptables -t nat -F
</span></span><span class="line"><span class="cl">iptables -t filter -F
</span></span><span class="line"><span class="cl">iptables -t mangle -F
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># by default (as policy) allow all output, but block all input</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (further down we add exceptions that allow some kinds of connections)</span>
</span></span><span class="line"><span class="cl">iptables -P INPUT DROP
</span></span><span class="line"><span class="cl">iptables -P OUTPUT ACCEPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Now some rules for incoming connections are added, each with iptables -A,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># so they&#39;ll be evaluated in this exact order</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># allow all connections on the loopback device lo (localhost, 127.x.x.x)</span>
</span></span><span class="line"><span class="cl">iptables -A INPUT -i lo -j ACCEPT
</span></span><span class="line"><span class="cl"><span class="c1"># if for some broken reason we get packets for the localhost net that are</span>
</span></span><span class="line"><span class="cl"><span class="c1"># are *not* from lo, drop them</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (if they&#39;re from lo, the previous rule already accepted them)</span>
</span></span><span class="line"><span class="cl">iptables -A INPUT -d 127.0.0.0/8 -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># for now, allow all incoming connections from VPN (wireguard) peers</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (*could* be limited to the ones actually needed: UDP 53 for dnsmasq,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  TCP 22 for ssh/git, TCP 80 for http)</span>
</span></span><span class="line"><span class="cl">iptables -A INPUT -i <span class="nv">$VPN</span> -j ACCEPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># SSHGuard detects SSH bruteforce attacks and adds their source IPs </span>
</span></span><span class="line"><span class="cl"><span class="c1"># to the sshguard4 (or sshguard6 for IPv6) ipsets. </span>
</span></span><span class="line"><span class="cl"><span class="c1"># So block connections from IPs in the set:</span>
</span></span><span class="line"><span class="cl">iptables -A INPUT -i <span class="nv">$WAN</span> -m <span class="nb">set</span> --match-set sshguard4 src -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># generally allow traffic for established connections</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (this includes replies to outgoing connections )</span>
</span></span><span class="line"><span class="cl">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># accept SSH connections on port 22 (unless sshguard has dropped them first)</span>
</span></span><span class="line"><span class="cl">iptables -A INPUT -i <span class="nv">$WAN</span> -p tcp --dport <span class="m">22</span> -j ACCEPT
</span></span><span class="line"><span class="cl"><span class="c1"># also accept connections to the wireguard server</span>
</span></span><span class="line"><span class="cl">iptables -A INPUT -i <span class="nv">$WAN</span> -p udp --dport <span class="m">51820</span> -j ACCEPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># some useful ICMP messages that we should probably allow:</span>
</span></span><span class="line"><span class="cl">iptables -A INPUT -p icmp --icmp-type fragmentation-needed -j ACCEPT
</span></span><span class="line"><span class="cl">iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT <span class="c1"># ping</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;.. now doing (basically) the same for IPv6 (ip6tables)&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># flush all existing rules</span>
</span></span><span class="line"><span class="cl">ip6tables -F
</span></span><span class="line"><span class="cl">ip6tables -t nat -F
</span></span><span class="line"><span class="cl">ip6tables -t filter -F
</span></span><span class="line"><span class="cl">ip6tables -t mangle -F
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># by default (as policy) allow all output, but block all input</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (further down we add exceptions that allow some kinds of connections)</span>
</span></span><span class="line"><span class="cl">ip6tables -P INPUT DROP
</span></span><span class="line"><span class="cl">ip6tables -P OUTPUT ACCEPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># allow all connections on localhost (::1)</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -i lo -j ACCEPT
</span></span><span class="line"><span class="cl"><span class="c1"># .. but no connections that have a localhost address but are not on lo</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -d ::1/128 -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Note: not creating any ip6tables rules for wireguard-internal traffic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (on wg0), as we only use IPv4 for that private internal network</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># drop all packets from IPv6 addresses that sshguard detected as attackers</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -i <span class="nv">$WAN</span> -m <span class="nb">set</span> --match-set sshguard6 src -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># generally allow traffic for established connections</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (this includes replies to outgoing connections )</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># accept SSH connections on port 22 (unless sshguard has dropped them first)</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -i <span class="nv">$WAN</span> -p tcp --dport <span class="m">22</span> -j ACCEPT
</span></span><span class="line"><span class="cl"><span class="c1"># also accept connections to the wireguard server</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -i <span class="nv">$WAN</span> -p udp --dport <span class="m">51820</span> -j ACCEPT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># allow the ICMPv6 types required for IPv6</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (and ping, it&#39;s always useful if you can ping your server)</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -p ipv6-icmp -m icmp6 --icmpv6-type <span class="m">1</span> -j ACCEPT <span class="c1"># dest unreachable</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -p ipv6-icmp -m icmp6 --icmpv6-type <span class="m">2</span> -j ACCEPT <span class="c1"># packet too big</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -p ipv6-icmp -m icmp6 --icmpv6-type <span class="m">3</span> -j ACCEPT <span class="c1"># time exceeded</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -p ipv6-icmp -m icmp6 --icmpv6-type <span class="m">4</span> -j ACCEPT <span class="c1"># parameter problem</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -p ipv6-icmp -m icmp6 --icmpv6-type <span class="m">128</span> -j ACCEPT <span class="c1"># echo request (ping)</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -p ipv6-icmp -m icmp6 --icmpv6-type <span class="m">133</span> -j ACCEPT <span class="c1"># router solicitation</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -p ipv6-icmp -m icmp6 --icmpv6-type <span class="m">134</span> -j ACCEPT <span class="c1"># router advertisement</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -p ipv6-icmp -m icmp6 --icmpv6-type <span class="m">135</span> -j ACCEPT <span class="c1"># neighbor solicitation</span>
</span></span><span class="line"><span class="cl">ip6tables -A INPUT -p ipv6-icmp -m icmp6 --icmpv6-type <span class="m">136</span> -j ACCEPT <span class="c1"># neighbor advertisement</span>
</span></span></code></pre></div></details>
<p>Make both scripts executable:<br>
<code># chmod 755 /root/scripts/firewall*</code></p>
<p>The safest way to test the firewall script is like this (executed in <code>/root/scripts/</code>):<br>
<code># ./firewall.sh ; sleep 60 ; ./firewall-flush.sh</code><br>
It will apply the firewall rules, then wait for 60 seconds, and then remove them again.
So you have one minute to test the rules, and if something went wrong and the rules lock
you out, you only have to wait for a minute and you can connect to the server again.</p>
<p>You could test if you can:</p>
<ul>
<li>ping the server - on your local machine run: <code>$ ping yourserver.example.com</code><br>
(replace &ldquo;yourserver.example.com&rdquo; with your servers domain or IP)</li>
<li>create new SSH connections: <code>$ ssh -S none user@yourserver.example.com </code><br>
(replace &ldquo;user&rdquo; with the username you&rsquo;re using to normally log in to that server)<br>
<code>-S none</code> makes sure that a new connection is established by disabling SSH connection sharing.</li>
<li>connect with WireGuard - if a connection is currently active disable it, then enable it again
(on Linux with <code># wg-quick down wg0</code> and <code># wg-quick up wg0</code>), then try to ping your server
through wireguard (<code>$ ping 172.30.0.1</code>)</li>
</ul>
<p>(make sure the rules are still active and haven&rsquo;t been flushed yet; you could of course sleep for
longer than a minute, e.g. <code>sleep 300</code> for five minutes)</p>
<p>You show display the current iptables rules for IPv4 by entering:<br>
<code># iptables-save</code><br>
and for IPv6:<br>
<code># ip6tables-save</code></p>
<p>(you could also use <code>iptables -L -v</code> or <code>ip6tables -L -v</code> if you find that output more readable)</p>
<p>If this all works, create a systemd service to ensure that the firewall script is automatically
run on boot.</p>
<p>Create a file <code>/etc/systemd/system/firewall.service</code> with the following contents:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-systemd" data-lang="systemd"><span class="line"><span class="cl"><span class="c">## Systemd service file for Daniels little firewall script</span>
</span></span><span class="line"><span class="cl"><span class="c">## makes sure that the firewall (iptables) rules are set on boot</span>
</span></span><span class="line"><span class="cl"><span class="k">[Unit]</span>
</span></span><span class="line"><span class="cl"><span class="na">Description</span><span class="o">=</span><span class="s">Firewall</span>
</span></span><span class="line"><span class="cl"><span class="na">Requires</span><span class="o">=</span><span class="s">network.target</span>
</span></span><span class="line"><span class="cl"><span class="na">After</span><span class="o">=</span><span class="s">network.target</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">[Service]</span>
</span></span><span class="line"><span class="cl"><span class="na">User</span><span class="o">=</span><span class="s">root</span>
</span></span><span class="line"><span class="cl"><span class="na">Type</span><span class="o">=</span><span class="s">oneshot</span>
</span></span><span class="line"><span class="cl"><span class="na">RemainAfterExit</span><span class="o">=</span><span class="s">yes</span>
</span></span><span class="line"><span class="cl"><span class="na">ExecStart</span><span class="o">=</span><span class="s">/root/scripts/firewall.sh</span>
</span></span><span class="line"><span class="cl"><span class="na">ExecStop</span><span class="o">=</span><span class="s">/root/scripts/firewall-flush.sh</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">[Install]</span>
</span></span><span class="line"><span class="cl"><span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</span></span></code></pre></div><p>Enable and start the firewall service:<br>
<code># systemctl enable firewall.service</code><br>
<code># systemctl start firewall.service</code></p>
<p>Check with <code># iptables-save</code> if the iptables rules have been created, reboot, make sure you still get
on the server (and the iptables rules are still/again there).</p>
<p><em>By the way:</em> If it takes a while after boot until WireGuard is started, the systemd <code>network-online.target</code>
might be hanging (the wg-quick service waits for that). You can check this by executing<br>
<code># systemctl status systemd-networkd-wait-online.service</code><br>
If the output says something about a timeout (instead of &ldquo;Finished Wait for Network to be Configured.&rdquo;),
execute<br>
<code># networkctl</code><br>
If the state of a device is &ldquo;configur<em>ing</em>&rdquo; instead of &ldquo;configur<em>ed</em>&rdquo; or &ldquo;unmanaged&rdquo;, that explains
why <code>systemd-networkd-wait-online.service</code> didn&rsquo;t succeed (and then gave up after a timeout so
services that wait for it at least start <em>eventually</em>).<br>
At least on our server the problem was that for some reason systemd&rsquo;s <em>networkd</em> doesn&rsquo;t properly
finish configuring a device if <strong>IPv6 is disabled</strong>, as it is the default on a Contabo VPS.
Contabo provides a command that can be executed to enable IPv6 <em>(but this is Contabo-specific, if
other hosters also disable IPv6 by default and you run into the same problem, refer to their documentation!):</em><br>
<code># enable_ipv6</code></p>
<blockquote>
<p><strong>NOTE:</strong> If your hoster offers VNC access to your server (which gives you access to a terminal
even if you can&rsquo;t reach the server through SSH anymore) and enables it by default (like Contabo does),
now that your firewall is working without locking you out is a good time to disable the VNC access,
so no one can try to break into your server through that.</p>
</blockquote>
<h1 id="setting-up-dnsmasq-as-dns-server-for-a-local-domain">Setting up dnsmasq as DNS server for a local domain</h1>
<p>This step will set up <a href="https://thekelleys.org.uk/dnsmasq/doc.html">dnsmasq</a> for the local
<code>example.lan</code> domain, so Forgejo will be reachable (in the VPN) under <code>http://git.example.lan</code>.</p>
<p>This isn&rsquo;t <em>strictly</em> needed, at least if you only host one http service on the server (or use different
ports for different services) - then you could access them with <code>http://172.30.0.1</code> or
<code>http://172.30.0.1:3000</code> - but it&rsquo;s definitely nice to have.</p>
<p>Of course you can use a different domain, like yourcompany.lan, but I think that using the nonexistant
.lan top-level-domain is a good idea for this purpose<sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup>. Alternatively you could use a subdomain of
a real domain you have, like vpn.yourcompany.com (and then maybe git.vpn.yourcompany.com), but to
be honest I&rsquo;m not completely sure how that would be set up properly.</p>
<p>We&rsquo;ll install and configure it to only listen on wg0 and to answer queries for <code>*.example.lan</code>.</p>
<p>Install the dnsmasq package:<br>
<code># apt install dnsmasq</code></p>
<p>Stop its systemd service, as its standard configuration clashes with systemd-resolved (and is not
what we need anyway):<br>
<code># systemctl stop dnsmasq.service</code></p>
<blockquote>
<p><strong>NOTE:</strong> If you&rsquo;re already using dnsmasq on your server, or want to use it for something else
as well, you can create alternative instance configurations as described in the
<a href="https://thekelleys.org.uk/gitweb/?p=dnsmasq.git;a=blob;f=debian/systemd_howto;hb=HEAD">systemd howto</a>
included in the dnsmasq debian/Ubuntu package (which relies on the dnsmasq systemd service as
defined in that package) to run multiple instances of dnsmasq at once.
For the sake of simplicity, this Howto assumes that&rsquo;s not needed and uses the standard config.</p>
</blockquote>
<p>As root, edit <code>/etc/default/dnsmasq</code></p>
<ul>
<li>Add the line <code>DOMAIN_SUFFIX=&quot;example.lan&quot;</code> (or &ldquo;yourcompany.lan&rdquo; or whatever you want to use);
make sure it&rsquo;s the only not commented-out line that sets DOMAIN_SUFFIX</li>
<li>Uncomment the <code>IGNORE_RESOLVCONF=yes</code> line (so it&rsquo;s in there <strong>without</strong> a <code>#</code> before it)</li>
<li>Uncomment (or add) the <code>DNSMASQ_EXCEPT=&quot;lo&quot;</code> line to ensure that dnsmasq will not be used as the
systems default resolver.</li>
</ul>
<p>Save the file and now edit <code>/etc/dnsmasq.conf</code> - in its initial states, all lines should be commented
out (begin with <code>#</code>).</p>
<p>The following lines should end up in dnsmasq.conf:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cfg" data-lang="cfg"><span class="line"><span class="cl"><span class="c1"># don&#39;t use resolv.conf to get upstream DNS servers</span>
</span></span><span class="line"><span class="cl"><span class="c1"># in our case, don&#39;t use any upstream DNS servers,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># only handle example.lan and fail for everything else</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (VPN clients shouldn&#39;t resolve their normal/global domains here)</span>
</span></span><span class="line"><span class="cl"><span class="na">noresolv</span>
</span></span><span class="line"><span class="cl"><span class="c1"># answer requests to *.example.lan from /etc/hosts</span>
</span></span><span class="line"><span class="cl"><span class="na">local</span><span class="o">=</span><span class="s">/example.lan/</span>
</span></span><span class="line"><span class="cl"><span class="c1"># only listen on the wireguard interface</span>
</span></span><span class="line"><span class="cl"><span class="na">interface</span><span class="o">=</span><span class="s">wg0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># only provide DNS, no DHCP</span>
</span></span><span class="line"><span class="cl"><span class="na">no-dhcp-interface</span><span class="o">=</span><span class="s">wg0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This option (only available on Linux AFAIK) will make sure that:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1. like with bind-interfaces, dnsmasq only binds to wg0 (instead of</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    binding to the wildcard address on all devices and then only</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    replying to requests on the requested device)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2. this works even with interfaces that might dynamically appear</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    and disappear, like VPN devices</span>
</span></span><span class="line"><span class="cl"><span class="na">bind-dynamic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># this (and the next option) expands simple hosts like &#34;horst&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># from /etc/hosts to &#34;horst.example.lan&#34;</span>
</span></span><span class="line"><span class="cl"><span class="na">expand-hosts</span>
</span></span><span class="line"><span class="cl"><span class="na">domain</span><span class="o">=</span><span class="s">example.lan</span>
</span></span></code></pre></div><p><em>(You could also delete or rename <code>/etc/dnsmasq.conf</code>and create a fresh one that only contains
the lines shown above)</em></p>
<p>Next edit <code>/etc/hosts</code>. dnsmasq uses hosts configured in that file to answer DNS requests.
Add the lines</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">172.30.0.1      www.example.lan example.lan
</span></span><span class="line"><span class="cl">172.30.0.1      git.example.lan
</span></span></code></pre></div><p>(if you want to use other aliases for other services add them as well, for example<br>
<code>172.30.0.1 openproject.example.lan</code>)</p>
<p>Now start dnsmasq again:<br>
<code># systemctl start dnsmasq.service</code></p>
<h2 id="configure-clients-to-use-the-dns-server">Configure clients to use the DNS server</h2>
<p>The VPN clients must be told to use the DNS server you just set up.</p>
<h3 id="linux-and-other-unix-likes">Linux and other Unix-likes</h3>
<p>On <strong>Linux</strong> distros that use <strong>systemd-resolved</strong> (are there other Unix-likes that use systemd?),
replace the <code>#PostUp = TODO</code> line line in the client&rsquo;s <code>/etc/wireguard/wg0.conf</code> with:<br>
<code>PostUp = resolvectl dns %i 172.30.0.1; resolvectl domain %i ~example.lan; resolvectl default-route %i false</code>
(yes, that must all go in one line to work!).</p>
<ul>
<li><code>resolvectl dns %i 172.30.0.1</code> sets 172.30.0.1 as the network-interface-specific DNS server
(Note that <code>%i</code> will be replaced with the interface name by <code>wg-quick</code>)</li>
<li><code>resolvectl domain %i ~example.lan</code> sets <code>example.lan</code> as the default domain for that interface,
and the <code>~</code> prefix makes it a &ldquo;routing (-only) domain&rdquo;, which means that all requests to that
domain (and its subdomains), in this case <code>*.example.lan</code>, should go to the DNS server(s) configured
for this interface.</li>
<li><code>resolvectl default-route %i false</code> means that this interfaces DNS server should <em>not</em> be used
as the default DNS server for DNS requests for domains not explicitly configured as &ldquo;routing domains&rdquo;.
This ensures that the dnsmasq running on <code>172.30.0.1</code> will <em>only</em> be used to resolve <code>example.lan</code>,
<code>git.example.lan</code>, <code>www.example.lan</code> etc, not any other domains like <code>blog.gibson.sh</code>
or <code>raspi.myhome.lan</code> or <code>xkcd.com</code>.</li>
<li>See <a href="https://www.freedesktop.org/software/systemd/man/resolvectl.html">man resolvectl</a>,
<a href="https://www.freedesktop.org/software/systemd/man/systemd.network.html">man systemd.network</a>
and <a href="https://systemd.io/RESOLVED-VPNS/">this article</a> for more information.</li>
</ul>
<p>For this setting to take effect, you&rsquo;ll have to disconnect and reconnect the wireguard connection
on the client (<code># wg-quick down wg0 &amp;&amp; wg-quick up wg0</code>)</p>
<p>On <em>other distributions or operating systems</em> (that <strong>don&rsquo;t use systemd-resolved</strong>),
this might be a bit harder, and depend on <em>what</em> they&rsquo;re using <em>exactly</em>, anyway.
Some of them use the <code>resolvconf</code> package/tool to manage <code>/etc/resolv.conf</code>, but as far as I know
and according to <a href="https://serverfault.com/questions/872109/resolv-conf-multiple-dns-servers-with-specific-domains">this serverfault.com answer</a>, it only supports setting <em>global</em> DNS servers
(that are used for all domains), and a suggested workaround is to install dnsmasq or similar on the
client and configure dnsmasq to use <code>172.30.0.1</code> for <code>example.lan</code> (and another DNS server for
all other requests) - the required line in dnsmasq.conf <em>on the client</em> would be
<code>server=/example.lan/172.30.0.1</code>.<br>
A simple workaround if you don&rsquo;t want to set up your own local caching DNS server (like dnsmasq):
Edit <code>/etc/hosts</code> <em>on the client</em> and add the hosts you need, like<br>
<code>172.30.0.1 git.example.lan www.example.lan whateverelse.example.lan</code><br>
Of course it means that if another subdomain is added on the server, you also need to add it locally,
but depending on your usecase this might be the path of least resistance&hellip;</p>
<blockquote>
<p><strong>NOTE:</strong> wg-quick allows setting a <code>DNS = 1.2.3.4</code> option under <code>[Interface]</code>.<br>
Even with a default search domain, like <code>DNS = 172.30.0.1, example.lan</code>.<br>
DO NOT USE THAT!<br>
It sets the global DNS server, meaning, it will be used for <em>all</em> your DNS requests,
not just the ones for <code>example.lan</code> - that&rsquo;s most probably not what you want, and when
dnsmasq is configured like described here it won&rsquo;t even work (as it won&rsquo;t know how to resolve
other domains like <code>gibson.sh</code> or <code>google.com</code>)!<br>
Furthermore, it only works with resolvconf, not systemd-resolved or Windows (AFAIK).</p>
</blockquote>
<h3 id="windows">Windows</h3>
<p>On Windows, WireGuard doesn&rsquo;t support PostUp scripts (unless explicitly enabled in the registry),
because apparently there are bigger security implications than on Linux.</p>
<p>So instead of setting the DNS server when connecting and removing it when disconnecting, just
configure it once and leave it configured, by entering the following command in an
<strong>Administrator</strong> PowerShell:<br>
<code>Add-DnsClientNrptRule -Namespace 'example.lan','.example.lan' -NameServers '172.30.0.1'</code></p>
<p>As this explicitly sets the DNS server only for <code>*.example.lan</code>, it shouldn&rsquo;t hurt much
that the server isn&rsquo;t reachable when the WireGuard connection is down - it just means that the DNS
request will timeout and fail in that case. .</p>
<blockquote>
<p><strong>NOTE:</strong> If you want to remove the rule again, entering<br>
<code>Get-DnsClientNrptRule</code> in an (Administrator) PowerShell will list rules
including their &ldquo;Name&rdquo; identifiers, and<br>
<code>Remove-DnsClientNrptRule -Name &quot;{6E6B2697-2922-49CF-B080-6884A4E396DE}&quot;</code>
deletes the rule with that identifier.</p>
</blockquote>
<h3 id="macos">macOS</h3>
<p>Again, I can&rsquo;t test this myself because I don&rsquo;t have a Mac, but I found
<a href="https://stanislas.blog/2020/02/different-nameservers-domains-macos/">a blog post</a>
that looks relevant.</p>
<p>The gist of it (in case it disappears in the future):
Create a textfile <code>/etc/resolver/example.lan</code> that contains the line
<code>nameserver 172.30.0.1</code></p>
<p>Apparently this doesn&rsquo;t work for all tools though (not for <code>dig</code>, for example), but according to
the blog post,
<code>$ scutils --dns</code> can be used to check if the setting was applied, and <code>ping</code> should also work.
The blog posts suggests trying a reboot in case it doesn&rsquo;t work at all.</p>
<p>I hope that it works with <code>git</code>, <code>git-lfs</code> and your web browser - if you try it,
please let me know how it went in a comment! :-)</p>
<h3 id="testing-the-dns-server">Testing the DNS server</h3>
<p>Now on the client you should be able to ping the new domains (if the WireGuard connection is active):<br>
<code>$ ping example.lan</code><br>
<code>$ ping git.example.lan</code></p>
<h1 id="setting-up-nginx-as-a-reverse-http-proxy">Setting up nginx as a reverse http proxy</h1>
<p><a href="https://nginx.org/">nginx</a> will be used as a webserver/reverse proxy, that makes
<code>http://www.example.lan</code> and <code>http://git.example.lan</code> and possibly other domains available,
redirecting them to other services based on the subdomain used (for example, the real git server, Forgejo,
will listen at port 3000/tcp, instead of the standard http port 80/tcp, and <a href="https://www.openproject.org/">OpenProject</a>, that nginx could provide at <code>http://openproject.example.lan</code>, listens on port 6000/tcp).</p>
<p>Install it with:<br>
<code># apt install nginx-light</code><br>
(at least for the purposes documented in this tutorial, you won&rsquo;t need the additional features
provided by the full nginx package)</p>
<p>The Debian/Ubuntu configuration of nginx (maybe other distros do the same) splits up the site-specific
nginx-configuration into one little config per site; they&rsquo;re configured in <code>/etc/nginx/sizes-available/*.conf</code>,
to actually enable a site, its config is symlinked to <code>/etc/nginx/sites-enabled/</code>.</p>
<p>By default, only <code>/etc/nginx/sites-available/default</code> exists (and is enabled), it shows the
static page from <code>/var/www/html/index.nginx-debian.html</code> (or index.htm or index.html in the same directory).
I&rsquo;d suggest keeping it like this; you could edit that default index.html to provide links to the pages
with content, like <code>http://git.example.lan</code> (once they exist..).</p>
<p>You should however make one little change to <code>/etc/nginx/sites-available/default</code>:
Replace the <code>listen 80 default_server;</code> line with <code>listen 172.30.0.1:80 default_server;</code> to make
sure that nginx only listens on the WireGuard IP and not on all IPs.</p>
<p>As we&rsquo;ll soon install Forgejo, we can already configure the site for it in nginx by creating
<code>/etc/nginx/sites-available/git</code> with the following content:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># should be reachable on port 80, only on WireGuard IP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">listen</span> <span class="n">172.30.0.1</span><span class="p">:</span><span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># the domain that&#39;s used (=&gt; will be available at http://git.example.lan)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">server_name</span> <span class="s">git.example.lan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># nginx defaults to a 1MB size limit for uploads, which
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># *definitely* isn&#39;t enough for Git LFS.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># &#39;client_max_body_size 300m;&#39; would set a limit of 300MB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># setting it to 0 means &#34;no limit&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">client_max_body_size</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Forgejo will listen on port 3000, on localhost
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:3000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># http proxy header settings that are required 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1"># according to the Forgejo/Gitea documentation:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Then create a symlink in <code>/etc/nginx/sites-enabled/</code>:<br>
<code># ln -s /etc/nginx/sites-available/git /etc/nginx/sites-enabled/git</code></p>
<p>and restart the nginx service:<br>
<code># systemctl restart nginx.service</code></p>
<p>Now you can already test it and it should work, <strong>but</strong> it likely won&rsquo;t work after <strong>rebooting</strong>,
because nginx will likely start before the WireGuard device (that provides the IP nginx is supposed
to listen on) is ready, and because of that will fail.<br>
To fix this we&rsquo;ll have to tell the nginx systemd service to start <em>after</em> WireGuard (wg-quick@wg0).
That&rsquo;s done with:<br>
<code># systemctl edit nginx.service</code><br>
which will open a text editor (with lots of stuff that&rsquo;s commented out) that allows you to
specify additional rules that overwrite the ones in the system nginx.service
(at <code>/usr/lib/systemd/system/nginx.service</code>; the override rules are saved in
<code>/etc/systemd/system/nginx.service.d/override.conf</code>). All that&rsquo;s needed here are the following lines:</p>
<pre tabindex="0"><code># tell systemd to start this service (nginx) after wg0 is up
# (=&gt; wg-quick@wg0 service is done)
# so nginx can bind to the WireGuard device&#39;s IP
[Unit]
After=wg-quick@wg0.service
</code></pre><p>(ok, the first three lines are just comments and not really needed).<br>
Save and exit the editor (if it&rsquo;s GNU nano, press Ctrl-X, then type <code>y</code> for &ldquo;yes I want to save&rdquo;
and press enter to confirm the preselected filename).<br>
With this change, if you reboot, nginx should (still) work.
If you need to, you can edit this again with the same command (<code># systemctl edit nginx.service</code>).</p>
<p>Now if you open a browser on a desktop PC connected to the server with WireGuard (that
has the DNS server configured as described in the previous chapter), you should be able to open
<a href="http://example.lan">http://example.lan</a> and <a href="http://git.example.lan">http://git.example.lan</a> (though the latter will show an error page because
Forgejo isn&rsquo;t installed yet).<br>
<strong>Note</strong> that you might have to actually type the whole URL including <code>http://</code> in the browser,
because nowadays browsers only open URLs without protocol (<code>http://</code>) for known top level domains,
otherwise they&rsquo;ll open a web search using &ldquo;git.example.lan&rdquo; or whatever you typed in as search
query<sup id="fnref:8"><a href="#fn:8" class="footnote-ref" role="doc-noteref">8</a></sup>..</p>
<p>As mentioned before, this uses plain HTTP, no HTTPS encryption, because:</p>
<ol>
<li>That would be a PITA to set up for a custom/local domain (you&rsquo;d have to create your own pseudo-CA
and import that at every client)</li>
<li>The connection to the server is already encrypted with WireGuard, so it already is secure
(even if your webbrowser may claim otherwise because it doesn&rsquo;t know that detail)</li>
<li>Not only is additional HTTPS encryption unnecessary, it&rsquo;d also be additional overhead, both
on the server and client CPUs that have to encrypt/decrypt the traffic twice and on the network
bandwidth, as both WireGuard and SSL/TLS (used by HTTPS) add their own metadata to each packet,
<em>in addition</em> to the http message you actually want to send/receive.</li>
</ol>
<blockquote>
<p><strong>NOTE:</strong> If you want to host Forgejo publicly, much of this article still applies (you&rsquo;d just
leave out the wireguard and DNS server parts). In that case you absolutely should use HTTPS
of course, and the place where you&rsquo;d configure it would be the nginx configuration.
See the <a href="https://nginx.org/en/docs/http/configuring_https_servers.html">nginx HTTPS documentation</a>
and their <a href="https://www.nginx.com/blog/using-free-ssltls-certificates-from-lets-encrypt-with-nginx/">blog post on using Let&rsquo;s Encrypt</a>
(if you want to use free Let&rsquo;s Encrypt SSL certificates) and
<a href="https://www.howtoforge.com/how-to-install-gitea-on-ubuntu-22-04/">this Howto</a>
on installing Gitea with Nginx and Let&rsquo;s Encrypt SSL.</p>
</blockquote>
<h1 id="setting-up-dma-as-sendmail-implementation">Setting up dma as sendmail implementation</h1>
<p>It&rsquo;s useful for a server to be able to send E-Mails.<br>
That can be used to tell you that an error happened, that updates are available, or it can just
be notifications from Forgejo or other software about new (comments on) bug reports, merge requests etc.</p>
<p>The standard way to do this on Unix-like systems is the /usr/sbin/sendmail tool; originally part of
a <a href="https://en.wikipedia.org/wiki/Sendmail">fully fledged mailserver</a>, but nowadays several different
programs implement that functionality, including minimal ones that don&rsquo;t implement SMTP themselves
but just send a mail through a configured external SMTP server.</p>
<p>This shows how to set up such a simple sendmail replacement, specifically
<a href="https://github.com/corecode/dma">dma</a>, as running a full mailserver isn&rsquo;t exactly straightforward
and also is against the idea of exposing as few possibly vulnerable services on this server
to the internet as possible.</p>
<p>So the idea is that you already have some E-Mail account that provides SMTP access (a freemailer,
your company mailserver, whatever), ideally with a special noreply-address just for this server.</p>
<p>Of course the first step is to install dma:<br>
<code># apt install dma</code></p>
<p>On Debian and Ubuntu, during the installation, you&rsquo;ll be asked to configure dma.
The <strong>&ldquo;System Mail Name&rdquo;</strong> shouldn&rsquo;t matter much, you can leave it at its default, the <strong>&ldquo;Smarthost&rdquo;</strong>
is the SMTP server you want to use.
Afterwards, you&rsquo;ll most probably still have to do some manual changes to the configuration, so (as root)
edit <code>/etc/dma/dma.conf</code> and:</p>
<ul>
<li>set <code>PORT 465</code> (for TLS/SSL encrypted communication with the SMTP server)</li>
<li>uncomment the <code>#AUTHPATH /etc/dma/auth.conf</code> line (remove the <code>#</code> at the beginning of the line)
so auth.conf with the smtp server login data will be used (we&rsquo;ll edit that next)</li>
<li>uncomment <code>#SECURETRANSFER</code> so TLS/SSL is used</li>
<li>set <code>MASQUERADE noreply@yourdomain.com</code> (with the noreply address you want to use for this)
to make sure that when sending mails it always uses that address as sender; your mailserver might
even reject mails that set other senders</li>
</ul>
<p>Now edit <code>/etc/dma/auth.conf</code> to set the login data for the smtp server by adding a line like:<br>
<code>noreply@yourdomain.com|smtp.yourdomain.com:YourPassw0rd</code><br>
where <code>smtp.yourdomain.com</code> is the same domain you set as &ldquo;Smarthost&rdquo;.</p>
<p>For other users than root to be able to use <code>dma</code> (or <code>sendmail</code>) to send a mail, the configs must
be readable by the <code>mail</code> group. Check with:<br>
<code>$ ls -lh /etc/dma/</code><br>
If the lines don&rsquo;t look like <code>-rw-r----- 1 root mail  250 May 15 15:28 auth.conf</code>, but show
another group than <code>mail</code> (maybe <code>root root</code>), change the ownership to user <code>root</code>, group <code>mail</code>, with:<br>
<code># chown root:mail /etc/dma/*.conf</code></p>
<p>For further information see the <a href="https://manpages.debian.org/testing/dma/sendmail.8.en.html">dma manpage</a>
and <a href="https://wiki.archlinux.org/title/Dma">the ArchWiki&rsquo;s dma page</a>.</p>
<blockquote>
<p><strong>NOTE:</strong> In case the E-Mail account you want to use is from <strong>GMail</strong> (or <del>Google Apps</del>
<del>G Suite</del> Google Workspace), setting this up is a bit more painful, as by default Google
doesn&rsquo;t support standard SMTP login anymore, but only OAuth2 based login (which is not supported
by dma or other similar tools that I know of). It requires setting up an &ldquo;App Password&rdquo;, see
<a href="https://support.google.com/accounts/answer/185833?hl=en">the Google documentation for that</a>
or <a href="https://help.mailreach.co/en/article/how-to-connect-a-gmail-google-workspace-account-to-mailreach-with-an-app-password-ulwj00/">this tutorial from Mailreach</a>
(though note that Google UI has changed slightly since it was created, to get to the
screen to create an App Password you currently need to click, in your normal mail view,
the <em>user button on the upper right -&gt; Manage your Google Account -&gt; Security
-&gt; How you sign in to Google -&gt; 2-Step Verification</em> and select &ldquo;App Passwords&rdquo; there).<br>
Also potentially useful:
<a href="https://pawait.africa/blog/googleworkspace/how-to-set-up-a-no-reply-email-with-a-custom-rejection-message-in-google-workspace/">This article</a>
on turning a Google-hosted E-Mail address into a No-Reply address that rejects mails sent to it.
(Note that it might take 15 minutes or so until that rejection rule is in effect)<br>
Also note that this is no endorsement for GMail (in fact I suggest not to use it),
but if you (or your company or project) are using it anyway, this information might be useful.</p>
</blockquote>
<h2 id="testing-the-sendmail-command">Testing the sendmail command</h2>
<p>Sending a mail on the commandline or a from script with sendmail is easy:
It the receiver addresses are commandline arguments and the mail subject and text is read from stdin.</p>
<p>So create a textfile like this:</p>
<pre tabindex="0"><code>Subject: This is a testmail!

This is the body of the test mail.
It&#39;s plain text.
You can probably somehow send HTML mails, but
1. I don&#39;t know how
2. Those suck anyway

Kind regards,
Your Server.
</code></pre><p>and then send the mail with:<br>
<code>$ /usr/sbin/sendmail name@example.com name2@example.com &lt; mailtext.txt</code></p>
<p>The log files <code>/var/log/mail.err</code> and <code>/var/log/mail.log</code> help debugging mail issues.</p>
<h2 id="redirect-local-mails-for-root-to-your-mail-account">Redirect local mails for root to your mail account</h2>
<p>Some services like sending mails with information (esp. detected problems) to the local account of
the <strong>root</strong> user. When you log in via SSH, you might be told that there are new mails and you can
read them with the <code>mail</code> tool. As it is, that&rsquo;s not overly useful, as you probably won&rsquo;t regularly
log into your server once it&rsquo;s set up.</p>
<p>Thankfully (due to dma supporting it), it&rsquo;s super easy to redirect those mails to a real mail account:
Just create a file
<code>/etc/aliases</code> with the following line:<br>
<code>root: name@example.com</code><br>
or, if multiple people should get those mails:<br>
<code>root: name@example.com, othername@example.com</code></p>
<p>This is even <strong>useful for mails from your own scripts</strong> (usually to indicate problems, see the backup
and the monitoring scripts below): You can just tell them to send mails to <code>root</code>, and then
<strong>configure who will actually get them</strong> (for example you and coworkers who administrate the server)
in this <strong>one central place</strong>, instead of hardcoding several E-Mail addresses all over the system.</p>
<p>You can test this as shown in the previous section, but with <code>root</code> as E-Mail address:<br>
<code>$ /usr/sbin/sendmail root &lt; mailtext.txt</code></p>
<h1 id="setting-up-forgejo-for-git-hosting">Setting up Forgejo for git hosting</h1>
<blockquote>
<p><strong>NOTE:</strong> <a href="https://forgejo.org/">Forgejo</a> is a fork of <a href="https://gitea.io/">Gitea</a>, and at least
as of release 1.19.3 they&rsquo;re very similar, so these instructions should work for both
(if you replace &ldquo;forgejo&rdquo; with &ldquo;gitea&rdquo; in paths etc).
Also, if you run into problems, searching your favorite search engine for <code>your problem &quot;gitea&quot;</code>
will probably give you more results than <code>your problem &quot;forgejo&quot;</code>, so it&rsquo;s worth trying.
Similarly, if the <a href="https://forgejo.org/docs/latest/">Forgejo Documentation</a> doesn&rsquo;t answer your
questions, check out the <a href="https://docs.gitea.io/en-us/">Gitea Documentation</a>.<br>
See <a href="https://forgejo.org/faq/">The Forgejo FAQ</a> for more information about the project and why they forked.</p>
<p>By the way, these Forgejo installation instructions roughly follow the
<a href="https://docs.gitea.io/en-us/installation/install-from-binary/">Gitea Installation from Binary documentation</a>
(at time of writing, Forgejo doesn&rsquo;t have installation instructions yet).</p>
</blockquote>
<h2 id="install-forgejo-and-git-create-git-user">Install Forgejo and git, create git user</h2>
<p>First, download the Forgejo binary for your CPU architecture and maybe verify the GPG signature,
as described on <a href="https://forgejo.org/download/">the Forgejo download page</a>.</p>
<p>Next, copy the downloaded Forgejo binary to <code>/usr/local/bin/</code> (renaming it to just &ldquo;forgejo&rdquo;)
and make it executable:<br>
<code># cp forgejo-1.19.3-0-linux-amd64 /usr/local/bin/forgejo</code><br>
<code># chmod 755 /usr/local/bin/forgejo</code></p>
<p>Make sure <code>git</code> and <code>git-lfs</code> are installed:<br>
<code># apt install git git-lfs</code></p>
<p>Create a user <code>git</code> on the system. Forgejo will run as that user, and when accessing git through ssh
(which is the default), this user is part of the URL <em>(for example in
<code>git clone git@git.example.lan:YourOrg/YourRepo.git</code> the <code>git</code> before the <code>@</code> is the user you&rsquo;ll create now).</em><br>
On <strong>Debian, Ubuntu</strong> and their derivates that&rsquo;s done with:</p>
<pre tabindex="0"><code># adduser --system --shell /bin/bash --gecos &#39;Git Version Control&#39; \
  --group --disabled-password --home /home/git  git
</code></pre><p>On <strong>Linux distributions not based on Debian/Ubuntu</strong> (this should at least work with Red Hat derivates
like Fedora, CentOS etc - <em>feel free to leave a comment about other distros!</em>), run this instead:</p>
<pre tabindex="0"><code># groupadd --system git

# adduser --system --shell /bin/bash --comment &#39;Git Version Control&#39; \
   --gid git --home-dir /home/git --create-home git
</code></pre><h2 id="create-directories-forgejo-will-use">Create directories Forgejo will use</h2>
<p>Now create the directories Forgejo will use and set access rights appropriately:</p>
<p><code># mkdir /var/lib/forgejo</code><br>
<code># chown git:git /var/lib/forgejo &amp;&amp; chmod 750 /var/lib/forgejo</code><br>
<em>This is the directory Forgejo will store its data in, including your git repos.</em></p>
<p><code># mkdir /etc/forgejo</code><br>
<code># chown root:git /etc/forgejo &amp;&amp; chmod 770 /etc/forgejo</code><br>
<em>This is the directory Forgejos config, called <code>app.ini</code>, is stored in. Initially it needs to
be writable by Forgejo, but after the installation you can make it read-only for Forgejo because
then it shouldn&rsquo;t modify it anymore.</em></p>
<h2 id="optional-set-up-database">Optional: Set up database</h2>
<p>When using sqlite as Forgejos database, nothing needs to be done here.</p>
<p>If you need a more powerful database, you can use MySQL/MariaDB or PostgreSQL (apparently sqlite
is good enough for at least 10 users, but might even suffice for more<sup id="fnref1:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> - and I read it&rsquo;s not
too hard to migrate the database from sqlite to something else later).</p>
<p>See <a href="https://forgejo.org/docs/latest/admin/database-preparation/">Forgejos Database Preparation guide</a>
for setup instructions.</p>
<h2 id="install-systemd-service-for-forgejo">Install systemd service for Forgejo</h2>
<p>Forgejo provides a
<a href="https://codeberg.org/forgejo/forgejo/src/branch/forgejo/contrib/systemd/forgejo.service">systemd service script</a>.
Download it to the correct location:<br>
<code># wget -O /etc/systemd/system/forgejo.service https://codeberg.org/forgejo/forgejo/raw/branch/forgejo/contrib/systemd/forgejo.service</code></p>
<p>If you&rsquo;re <em>not</em> using sqlite, but MySQL or MariaDB or PostgreSQL, you&rsquo;ll have to edit that file
(<code>/etc/systemd/system/forgejo.service</code>) and uncomment the corresponding <code>Wants=</code> and <code>After=</code> lines.
<del>Otherwise it <em>should</em> work as it is.</del></p>
<blockquote>
<p><strong>NOTE:</strong> For Forgejo 1.19.x, make sure that <code>forgejo.service</code> sets <code>Type=simple</code>, <em>not</em> <code>Type=notify</code>!
<em>(The forgejo.service currently available in their main branch sets <code>Type=notify</code>, which only
works with the current 1.20 development code, not release 1.19.3,
<a href="https://codeberg.org/forgejo/forgejo/issues/777">see this bugreport</a>).</em></p>
</blockquote>
<p>Now enable and start the Forgejo service, so you can go on with the installation:<br>
<code># systemctl enable forgejo.service</code><br>
<code># systemctl start forgejo.service</code></p>
<h2 id="forgejos-web-based-configuration">Forgejos web-based configuration</h2>
<p>You should now be able to access Forgejo in your local web browser, so open <a href="http://git.example.lan/">http://git.example.lan/</a>
(make sure your WireGuard connection is enabled).</p>
<p>If it doesn&rsquo;t work:</p>
<ul>
<li>Make sure the forgejo service started successfully by checking the output of<br>
<code># systemctl status forgejo.service</code><br>
If that indicates an error but the log lines underneath are too incomplete to tell what caused it,<br>
<code># journalctl -n 100 --unit forgejo.service</code><br>
will print the last 100 lines logged by Forgejo.</li>
<li>Try <a href="http://git.example.lan:3000/">http://git.example.lan:3000/</a> instead - that&rsquo;s the port Forgejo listens on,
this way nginx is circumvented <em>(later we&rsquo;ll configure Forgejo to make it only accessible through nginx)</em>.
If that works, <a href="#setting-up-nginx-as-a-reverse-http-proxy">fix your nginx setup</a>.</li>
<li>Try to ping <code>172.30.0.1</code> - if that fails, <a href="#setting-up-a-wireguard-vpn-server">make sure your WireGuard connection works</a></li>
<li>Try to ping <code>git.example.lan</code> - if you can&rsquo;t, fix your
<a href="#setting-up-dnsmasq-as-dns-server-for-a-local-domain">DNS setup</a>
(also <a href="#configure-clients-to-use-the-dns-server">on the client</a>!)</li>
</ul>
<p>You should be greeted by Forgejos &ldquo;Initial Configuration&rdquo; screen.<br>
The settings should be mostly self-explanatory, some hints:</p>
<ul>
<li>Select the correct database (SQLite3, or if you configured something else in the
<a href="#optional-set-up-database">Set up database</a> step, select that and set the corresponding options)</li>
<li><strong>Server Domain</strong> should be <code>git.example.lan</code> (or whatever you&rsquo;re actually using),<br>
<strong>Forgejo Base URL</strong> should be <code>http://git.example.lan</code></li>
<li>Ignore the <strong>Email Settings</strong> - Forgejo can be easily configured to use system sendmail (dma), but
(at least in version 1.19) only in the app.ini, not in the web interface, so we&rsquo;ll do that later.</li>
<li>Check the <strong>Server and Third-Party Service Settings</strong> settings for settings that look relevant
for you.</li>
<li>I think it makes sense to create the administrator account right now (<strong>Administrator Account Settings</strong>),
even more so if you disabled self-registration.</li>
<li>Most settings can be easily changed in <code>/etc/forgejo/app.ini</code> later, so don&rsquo;t worry about them too much.</li>
</ul>
<p>Once you&rsquo;re done configuring, click <code>Install Forgejo</code> and a few seconds later you should be
on the dashboard (if you created an administrator account) or at the login/register screen, where you
can create an account to then get to the dashboard.</p>
<p>So far, so good<sup id="fnref:9"><a href="#fn:9" class="footnote-ref" role="doc-noteref">9</a></sup>, but we&rsquo;re not quite done yet - some manual configuration in the app.ini is needed!</p>
<h2 id="further-configuration-in-forgejos-app-ini">Further configuration in Forgejos app.ini</h2>
<p>Stop the forgejo service:<br>
<code># systemctl stop forgejo.service</code></p>
<p>While at it, make <code>/etc/forgejo/</code> and the <code>app.ini</code> read-only for the git user (Forgejo doesn&rsquo;t
write to it after the initial configuration):<br>
<code># chmod 750 /etc/forgejo &amp;&amp; chmod 640 /etc/forgejo/app.ini</code></p>
<p>Now (as root) edit <code>/etc/forgejo/app.ini</code></p>
<blockquote>
<p><strong>NOTE:</strong> You&rsquo;ll probably find the
<a href="https://forgejo.org/docs/latest/admin/config-cheat-sheet/">Configuration Cheat Sheet</a> and the
<a href="https://codeberg.org/forgejo/forgejo/src/branch/forgejo/custom/conf/app.example.ini">Example app.ini</a>
that contains all options incl. descriptions helpful.</p>
</blockquote>
<p>I recommend the following changes (in the order of where I put them in the app.ini):</p>
<ul>
<li>Forgejo allows uploading files to git repos through the web interface.
By default the <strong>file size for uploads</strong>
is limited to 3MB per file, and 5 files at once. To increase it, under the <code>[repository]</code> section,
add a <code>[repository.upload]</code> section with a line like <code>FILE_MAX_SIZE = 4095</code>
(that would be 4095MB, about 4GB) and <code>MAX FILES = 20</code>
It&rsquo;ll look somehow like this:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">...</span>
</span></span><span class="line"><span class="cl"><span class="k">[repository]</span>
</span></span><span class="line"><span class="cl"><span class="na">ROOT</span> <span class="o">=</span> <span class="s">/var/lib/forgejo/data/forgejo-repositories</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[repository.upload]</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; max size for files to the repo via web interface, in MB, </span>
</span></span><span class="line"><span class="cl"><span class="c1">;; defaults to 3 (this sets a limit of about 4GB)</span>
</span></span><span class="line"><span class="cl"><span class="na">FILE_MAX_SIZE</span> <span class="o">=</span> <span class="s">4095</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; by default 5 files can be uploaded at once, increase to 20</span>
</span></span><span class="line"><span class="cl"><span class="na">MAX_FILES</span> <span class="o">=</span> <span class="s">20</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[server]</span>
</span></span><span class="line"><span class="cl"><span class="na">...</span>
</span></span></code></pre></div>Similar restrictions restrictions exist for attachments to issues/pull requests, configured
in the <a href="https://forgejo.org/docs/latest/admin/config-cheat-sheet/#issue-and-pull-request-attachments-attachment"><code>[attachment]</code> sections</a>
<code>MAX_SIZE</code> (default 4MB) and <code>MAX_FILES</code> (default 5) settings.</li>
<li>In the <code>[server]</code> section add a line <code>HTTP_ADDR = 127.0.0.1</code> to ensure that Forgejo <strong>only
listens on localhost</strong> and is not reachable from the outside at all, except through nginx.</li>
<li>By default <strong>LFS data uploads expire</strong> after 20 minutes - this can be too short for big files,
slow connections or slow LFS storage (git-lfs seems to automatically restart the upload then -
which means that it can take forever and use lots of traffic)..<br>
If you&rsquo;re going to use LFS with big uploads, increase thus limit, by adding a line
<code>LFS_HTTP_AUTH_EXPIRY = 180m</code> (for 180 minutes) to the <code>[server]</code> section.</li>
<li>Similarly there are timeouts for all kinds of git operations, that can be too short.<br>
I ran into the problem that a migration of a big repository from our old Gitlab server timed out
and left the repository in an inconsistent state
(<a href="https://codeberg.org/forgejo/forgejo/issues/715">due to a bug in Forgejo/Gitea</a> that
<a href="https://github.com/go-gitea/gitea/pull/24605">should be fixed in the next version</a> I wasn&rsquo;t even
warned about this in the web interface, there were only some log messages).<br>
Anyway, I <strong>increased all those git timeouts</strong> by adding a <code>[git.timeout]</code> section
below the <code>[server]</code> section:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="c1">;; Git Operation timeout in seconds</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; increase the timeouts, so importing big repos (and presumably</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; pushing large files?) hopefully won&#39;t fail anymore</span>
</span></span><span class="line"><span class="cl"><span class="k">[git.timeout]</span>
</span></span><span class="line"><span class="cl"><span class="na">DEFAULT</span> <span class="o">=</span> <span class="s">3600 ; Git operations default timeout seconds</span>
</span></span><span class="line"><span class="cl"><span class="na">MIGRATE</span> <span class="o">=</span> <span class="s">6000 ; Migrate external repositories timeout seconds</span>
</span></span><span class="line"><span class="cl"><span class="na">MIRROR</span>  <span class="o">=</span> <span class="s">3000 ; Mirror external repositories timeout seconds</span>
</span></span><span class="line"><span class="cl"><span class="na">CLONE</span>   <span class="o">=</span> <span class="s">3000 ; Git clone from internal repositories timeout seconds</span>
</span></span><span class="line"><span class="cl"><span class="na">PULL</span>    <span class="o">=</span> <span class="s">3000 ; Git pull from internal repositories timeout seconds</span>
</span></span><span class="line"><span class="cl"><span class="na">GC</span>      <span class="o">=</span> <span class="s">600  ; Git repository GC timeout seconds</span>
</span></span></code></pre></div>I increased all timeouts to factor 10 (by adding a 0 at the end); probably not all these timeouts
need to be increased (and if, then maybe not this much)&hellip; use your own judgement, this worked for me ;-)</li>
<li>By default LFS files are stored in the filesystem, in <code>/var/lib/forgejo/data/lfs</code>.
In the <code>[lfs]</code> section you can change the <code>PATH = ...</code> line to store elsewhere, but you can also
configure Forgejo to store the files in an S3-like Object-Storage. More information on that in the
<a href="#local-storage-vs-object-storage-for-lfs">object storage subchapter below</a>.</li>
<li>Enable sending E-Mails with sendmail/dma by changing the <code>[mailer]</code> section like this:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[mailer]</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; send mail with systemwide &#34;sendmail&#34; (actually dma in our case)</span>
</span></span><span class="line"><span class="cl"><span class="na">ENABLED</span> <span class="o">=</span> <span class="s">true</span>
</span></span><span class="line"><span class="cl"><span class="na">PROTOCOL</span> <span class="o">=</span> <span class="s">sendmail</span>
</span></span><span class="line"><span class="cl"><span class="na">FROM</span> <span class="o">=</span> <span class="s">&#34;Forgejo Git&#34; &lt;noreply@yourdomain.com&gt;</span>
</span></span></code></pre></div></li>
</ul>
<p>When you&rsquo;re done editing the app.ini, save it and start the forgejo service again:<br>
<code># systemctl start forgejo.service</code></p>
<p>You can test sending a mail by clicking the user button on the upper right of the Forgejo page
(&ldquo;Profile and Settings&rdquo;), then <code>Site Administration</code>, then <code>Configuration</code> and under
<code>Mailer Configuration</code> type in your mail address and click <code>Send Testing Email</code>.</p>
<h2 id="general-hints-for-using-forgejo">General hints for using Forgejo</h2>
<p>If you&rsquo;ve used Github or Gitlab before, the user interface should be familiar; if you&rsquo;re not sure
how something is done, consult the <a href="https://forgejo.org/docs/latest/user/">Forgejo user guide</a> and/or
<a href="https://forgejo.org/docs/latest/admin/">Forgejo administrator guide</a>. If that doesn&rsquo;t answer your
questions check the <a href="https://docs.gitea.io/en-us/">Gitea documentation</a> or
<a href="https://forgejo.org/docs/latest/admin/seek-assistance/">ask the Forgejo community</a>.</p>
<p>Remember that to use Git you&rsquo;ll need to add your SSH public key to Forgejo (User Button on upper right -&gt;
<code>Settings</code> -&gt; <code>SSH / GPG Keys</code> -&gt; <code>[Add Key]</code>, paste the contents of <code>$HOME/.git/id_rsa.pub</code>)</p>
<p>Sometimes you may want/need to use the Forgejo
<a href="https://forgejo.org/docs/latest/admin/command-line/">command line interface</a>.
Keep in mind that:</p>
<ul>
<li>You need to <strong>run it as <code>git</code> user</strong>, for example with <code>$ sudo -u git forgejo command --argument</code></li>
<li>You need to specify the <strong>Forgejo work path</strong>, either with the <code>--work-path /var/lib/forgejo</code>
(or <code>-w /var/lib/forgejo</code>) commandline option or by setting the <code>FORGEJO_WORK_DIR</code> environment variable
(<code>$ export FORGEJO_WORK_DIR=/var/lib/forgejo</code>) before calling <code>forgejo</code></li>
<li>You need to specify the path to the config (app.ini) with <code>--config /etc/forgejo/app.ini</code>
(or <code>-c /etc/forgejo/app.ini</code>).</li>
</ul>
<p>So all in all your command might look like:<br>
<code>$ sudo -u git forgejo -w /var/lib/forgejo -c /etc/forgejo/app.ini admin user list</code></p>
<blockquote>
<p><strong><em>For convenience</em></strong>, you could create a <code>/usr/local/bin/forgejo.sh</code> with the following contents:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>sudo -u git forgejo -w /var/lib/forgejo -c /etc/forgejo/app.ini <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span></code></pre></div><p>and make it executable:<br>
<code># chmod 755  /usr/local/bin/forgejo.sh</code></p>
<p>Now if you want to call <code>forgejo</code> on the commandline (for the default system-wide installation
in <code>/var/lib/forgejo</code>), just use e.g. <code>$ forgejo.sh admin user list</code> instead of the long
line shown above.</p>
</blockquote>
<p>You can always call forgejo and its subcommands with <code>-h</code> or <code>--help</code> to make it output usage
information like available options and (sub)commands, for example<br>
<code>$ forgejo admin user -h</code><br>
to show available subcommands to administrate users on the commandline.</p>
<h2 id="local-storage-vs-object-storage-for-lfs">Local storage vs. object storage for LFS</h2>
<p>Instead of storing the LFS files locally on the server (by default under <code>/var/lib/forgejo/data/lfs/</code>),
Forgejo (and Gitea) supports storing them in an (<a href="https://aws.amazon.com/s3/">Amazon S3</a>-compatible)
<em>object storage</em>. If your server is at risk of running out of diskspace, it <em>might</em> be easier/cheaper
to host the LFS files in an object storage instead of renting a bigger server.</p>
<p>While Amazon S3 itself is way too expensive, there are open source solutions (like <a href="https://min.io/">MinIO</a>
or <a href="https://ceph.io/">Ceph</a>) that implement S3&rsquo;s protocol, and providers that use those to offer S3-like
object storage for much more affordable prices, starting at around $10/month for 1TB<sup id="fnref:10"><a href="#fn:10" class="footnote-ref" role="doc-noteref">10</a></sup>.</p>
<p>To use such an object storage, the <code>[lfs]</code> section in <code>/etc/forgejo/app.ini</code> would look kinda like this
(<a href="https://forgejo.org/docs/latest/admin/config-cheat-sheet/#lfs-lfs">see also documentation</a>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[lfs]</span>
</span></span><span class="line"><span class="cl"><span class="c1">; PATH = /var/lib/forgejo/data/lfs ; only used for local storage</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; adjust these settings for the logindata of your object storage provider</span>
</span></span><span class="line"><span class="cl"><span class="na">STORAGE_TYPE</span>     <span class="o">=</span> <span class="s">minio</span>
</span></span><span class="line"><span class="cl"><span class="na">MINIO_ENDPOINT</span>   <span class="o">=</span> <span class="s">endpoint-url.com</span>
</span></span><span class="line"><span class="cl"><span class="na">MINIO_ACCESS_KEY_ID</span>     <span class="o">=</span> <span class="s">YOUR_ACCESS_KEY_ID</span>
</span></span><span class="line"><span class="cl"><span class="na">MINIO_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="s">YOUR_SECRET_ACCESS_KEY</span>
</span></span><span class="line"><span class="cl"><span class="na">MINIO_BUCKET</span>     <span class="o">=</span> <span class="s">gitea</span>
</span></span><span class="line"><span class="cl"><span class="na">MINIO_USE_SSL</span>    <span class="o">=</span> <span class="s">true ; encrypt connections to the object storage</span>
</span></span><span class="line"><span class="cl"><span class="c1">;; if your object storage provider needs it, set the location</span>
</span></span><span class="line"><span class="cl"><span class="c1">; MINIO_LOCATION: us-east-1</span>
</span></span></code></pre></div><p>(Refer to your object storage providers documentation on how to get the needed keys and what the endpoint is.)</p>
<blockquote>
<p><strong>One thing to keep in mind</strong> with object storage is that when making <strong>backups</strong> of Forgejo, the data
in object storage isn&rsquo;t easily backed up together with the rest, because it&rsquo;s not on the same server.
So unless you trust the object storage provider to keep your data with enough redundancy that it will
never get destroyed (if their datacenter burns down, for example), you need to back up the data in
the object storage in an additional step after the <a href="#backups-with-restic">&ldquo;normal&rdquo; backup of your server</a>.
<a href="https://rclone.org/">Rclone</a> is a great tool to access object storage (and lots of other kinds of
remote storage) and allows you to mount the object storage as a local virtual filesystem, so you
can copy its contents to a local backup disk, for example (or copy it to a different cloud storage;
you could probably even run <strong>restic</strong> on the mounted folder).</p>
</blockquote>
<h3 id="migrating-to-from-object-storage">Migrating to/from object-storage</h3>
<p>You can also migrate to object-storage later (or back from object-storage to local storage).
<em>(You don&rsquo;t need this when setting up forgejo initially, only if commits with LFS data have already
been pushed to the server!)</em></p>
<p>To migrate, first stop Forgejo (<code># systemctl stop forgejo.service</code>).</p>
<p>To migrate LFS from local storage to object-storage (<strong>while the app.ini still has local storage
configured!</strong>) run:<br>
<code>$ sudo -u git forgejo -w /var/lib/forgejo/ -c /etc/forgejo/app.ini migrate-storage -t lfs -s minio --minio-endpoint endpoint-url.com --minio-access-key-id YOUR_ACCESS_KEY_ID --minio-secret-access-key YOUR_SECRET_ACCESS_KEY --minio-bucket gitea --minio-use-ssl </code></p>
<p>To migrate from S3-like object-storage back to local (<strong>while the app.ini still has minio object
storage configured!</strong>) run:<br>
<code>$ sudo -u git forgejo -w /var/lib/forgejo/ -c /etc/forgejo/app.ini migrate-storage -t lfs -s local -p /var/lib/forgejo/data/lfs</code></p>
<p>After the migration is done, adjust <code>/etc/forgejo/app.ini</code> for the new storage type and start Forgejo
again (<code># systemctl start forgejo.service</code>).</p>
<p>When you&rsquo;re done migrating <em>to</em> object storage, you may want to delete <code>/var/lib/forgejo/data/lfs/*</code>
to free up the disk space.</p>
<h1 id="backups-with-restic">Backups with restic</h1>
<p><a href="https://restic.net/">Restic</a> is a powerful backup tool that&rsquo;s easy to install and relatively easy
to use.<br>
Restic creates <strong>incremental backups</strong> - each time it&rsquo;s run for a specific path, it creates a new
<strong>snapshot</strong> for it (that can later be restored), but only saves the difference to the last snapshot,
which is pretty <strong>space-efficient</strong> and <strong>fast</strong>. Furthermore, it <strong>compresses</strong> the backups
(saves even more space) and <strong>encrypts</strong> them, so if someone gets access to wherever you store you
backups (for example backup space provided by your hoster), they still can&rsquo;t access your data
<em>(unless the attacker somehow managed to steal your password as well, but it&rsquo;s not stored with the
backups, of course)</em>.</p>
<p>It directly supports <strong>storing the backups</strong> on a <strong>local path</strong>, or on <strong>another server</strong> with a
variety of protocols including SFTP, the Amazon S3 protocol and a custom REST protocol - and when
combining it with <a href="https://rclone.org/">Rclone</a> (which it supports out of the box, if Rclone is
installed), it supports literally dozens of additional protocols and providers, including FTP(S),
WebDAV (ownCloud/Nextcloud), Google Drive, MS OneDrive, SMB/CIFS (Windows share)
<a href="https://rclone.org/#providers">and more</a>.</p>
<blockquote>
<p><strong>NOTE:</strong> If you don&rsquo;t want to do (automated) backups because setting up the server
is easy enough and all local git clones contain the whole history anyway:<br>
Yes, that&rsquo;s <em>mostly</em> true, but please keep in mind that when using git <strong>LFS</strong>, the local clones
by default do <strong>not have the whole history</strong> of files managed with LFS, but only the version
currently checked out.
However, calling <code>$ git lfs fetch --all</code> <em>does</em> download all git LFS objects (but of course uses
a lot more disk space on your PC).</p>
</blockquote>
<h2 id="installing-restic">Installing restic</h2>
<p>Download their <a href="https://github.com/restic/restic/releases/latest">latest release</a> for your platform
(probably linux_amd64) and extract it:<br>
<code>$ bunzip2 restic_0.15.2_linux_amd64.bz2</code><br>
(adjust filename for the version your downloaded)<br>
Then copy it to <code>/usr/local/bin/restic</code>:<br>
<code># cp restic_0.15.2_linux_amd64 /usr/local/bin/restic</code><br>
and make it executable:<br>
<code># chmod 755 /usr/local/bin/restic</code></p>
<h2 id="optional-install-and-configure-rclone">Optional: Install and configure Rclone</h2>
<p>If you want to upload your backups to a storage provider not directly supported by restic
(check <a href="https://restic.readthedocs.io/en/stable/030_preparing_a_new_repo.html">this list</a>),
you&rsquo;ll need to install Rclone.</p>
<p>You can download it at <a href="https://rclone.org/downloads/">https://rclone.org/downloads/</a> - I chose the <code>.deb</code> version for
&ldquo;Intel/AMD - 64 Bit&rdquo; (I guess it should work on most recent-ish versions of Debian, Ubuntu and derivates)
and installed it with:<br>
<code># dpkg -i ./rclone-v1.62.2-linux-amd64.deb</code></p>
<blockquote>
<p><strong>NOTE:</strong> Ubuntu provides an rclone package in their repo as well, but it&rsquo;s older (1.53).
For best compatibility with storage providers, using the latest version is probably best.<br>
(I couldn&rsquo;t get 1.53 to work with Google Drive, I think the authorization link changed
since 1.53 was released).</p>
</blockquote>
<p>You can configure a remote (incl. login-data etc) with<br>
<code># rclone config</code><br>
<em>(this doesn&rsquo;t generally require root privileges, but as you&rsquo;re going to use this with restic
that will be run as root, configure rclone as/for root as well)</em><br>
Find your provider in <a href="https://rclone.org/#providers">this list</a> and click the <code>(Config)</code> button
on the right to get detailed provider-specific instructions (make sure to read them completely,
for example for Google Drive, their
<a href="https://rclone.org/drive/#making-your-own-client-id"><em>Making your own client_id</em></a> section is said
to be important to get decent performance).</p>
<p>Remember the <strong><em>name</em></strong> you chose for the remote, you&rsquo;ll have to pass it to restic as &ldquo;repository&rdquo;
(with <code>-r</code> or in the <code>$RESTIC_REPOSITORY</code> environment variable) in the form
<code>rclone:NameYouChose:basePathFor/backup</code>.</p>
<p>One nice feature of rclone is that you can <a href="https://rclone.org/commands/rclone_mount/"><strong>mount remotes</strong></a>,
which allows accessing the files on your remote storage like they were on a (probably pretty slow..)
local harddisk (or, maybe closer to the truth, a mounted network share).<br>
<em>I&rsquo;ve used this to copy the restic binary and the clone package to the cloud storage, so if I have to
restore the backup on a fresh system I have the exact same versions for restic and rclone, which
should ensure compatibility with the backed up data (in theory restics backup data format could
change in the future).</em></p>
<h2 id="setting-up-a-new-restic-backup-repository">Setting up a new restic backup repository</h2>
<p>First create a directory <code>/root/backup/</code> that the backup script and logs and some other things will
put in. Then create an empty file <code>.restic-pw.txt</code> in it, make sure that it can only be accessed by root
and then edit it.<br>
<code># mkdir /root/backup &amp;&amp; cd /root/backup</code><br>
<code># touch .restic-pw.txt &amp;&amp; chmod 600 .restic-pw.txt</code></p>
<p>That file will contain the password used by restic to encrypt the backup. I suggest using a long
completely random password - you shouldn&rsquo;t have to type it in, but use that file (or a copy) instead.
You can <em>either</em> use a <strong>text editor</strong> to fill in the password, <em>or</em> generate one with a tool like
<strong><code>pwgen</code></strong> (can be installed with <code># apt install pwgen</code>) and store it directly in the file, like:<br>
<code># pwgen -1ncys 32 &gt; .restic-pw.txt</code><br>
<em>This creates a single (<code>-1</code> - that&rsquo;s a one) password consisting of <code>32</code> characters:
at least one <code>c</code>apital letter, one <code>n</code>umber, one &ldquo;special s<code>y</code>mbol&rdquo; and is
<code>s</code>secure/&ldquo;completely random&rdquo; (instead of easily memorable).</em></p>
<p><strong>!! Make a local copy of <code>.restic-pw.txt</code> on your machine !!</strong><br>
<strong>!! Without this password the backups can&rsquo;t be restored !!</strong><br>
Or put it on a (possibly encrypted) USB memory key or whatever, and maybe give a copy to a trusted
friend or coworker (depending on what your server is for). The point is, if your server dies for some
reason - <em>this can absolutely happen and is the main scenario backups are for, right?</em> - you obviously
won&rsquo;t be able to access it to get the password from the file. But you&rsquo;ll need the password to
restore the backup on your new server.</p>
<blockquote>
<p><strong>NOTE:</strong> Because of restics clever design, you&rsquo;re able to change the password later (see
<a href="https://restic.readthedocs.io/en/stable/070_encryption.html">restic Encryption documentation</a>),
or even have multiple passwords. This is possible because restic generates its own completely
random password for the encryption of the actual backed up data - and only uses your key to encrypt
its generated key (the generated key, encrypted with your key, is stored on the backup server
together with the backed up data). So if you change the key, restic only needs to decrypt the
generated key with your old key and encrypt it again with your new key (and delete the old version
of the encrypted key).</p>
</blockquote>
<p>Anyway, time to <strong>finally initialize the restic backup repository!</strong><br>
That&rsquo;s done with:<br>
<code># restic -r YOUR_RESTIC_REPO -p /root/backup/.restic-pw.txt init</code><br>
You need to replace <code>YOUR_RESTIC_REPO</code> with something that&rsquo;s specific to the storage backend you want
to use, see <a href="https://restic.readthedocs.io/en/stable/030_preparing_a_new_repo.html">the restic docs for details</a>.</p>
<p><strong>NOTE:</strong> Instead of providing the repo name and password file with commandline arguments,
you can also use <strong>environment variables</strong>, like:<br>
<code># export RESTIC_REPOSITORY=&quot;/mnt/backup-disk/&quot;</code><br>
<em>(that example is for a local backup disk mounted at <code>/mnt/backup-disk/</code>, more useful for your
PC/laptop than a server in a datacenter)</em><br>
<code># export RESTIC_PASSWORD_FILE=&quot;/root/backup/.restic-pw.txt&quot;</code><br>
Afterwards you can run restic commands without specifying <code>-r</code> or <code>-p</code>.<br>
The remaining example restic calls in this Howto will do just that.</p>
<p><strong>Example:</strong> If your backup server can be accesses through <strong>SFTP (SSH)</strong> at address
<code>backup-host.example</code>, and you want to store the backup data in the directory <code>/srv/restic/</code>
on that server, you&rsquo;d use something like:<br>
<code># export RESTIC_REPOSITORY=&quot;sftp:user@backup-host.example:/srv/restic&quot;</code><br>
<code># restic init</code></p>
<p>If you&rsquo;re using <strong>Google Drive through Rclone</strong> and named the Rclone remote &ldquo;gdrive&rdquo; and want to
store the backups under <code>backups/gitserver</code> in the Google drive, it&rsquo;d look like:<br>
<code># export RESTIC_REPOSITORY=&quot;rclone:gdrive:backups/gitserver&quot;</code><br>
<code># restic init</code></p>
<p>For most other backends you&rsquo;ll need to set environment variables with access keys,
see <a href="https://restic.readthedocs.io/en/stable/030_preparing_a_new_repo.html">the documentation</a>.</p>
<p>Once the <code>init</code> step has finished successfully, you&rsquo;re ready to backup with restic!</p>
<h2 id="actually-backing-up">Actually backing up</h2>
<p>Generally, backing up is done with <code># restic backup /path1 /path2 /path3</code>.
This will create one snapshot containing those three paths - and if they have been backed up (together)
before, that snapshot will be based on the last one and only the difference will be stored, which
makes backing up pretty fast and small.</p>
<p>So each call to <code>restic backup</code> creates a new snapshot - IMHO this is a bit annoying, I&rsquo;d like to
do multiple successive calls for different services on the same server (and in between stop/restart
those services) and still have them grouped in one logical snapshot, but it is what it is, and
I can live with it.. just keep it in mind when browsing snapshots (e.g. after <code>restic mount</code>).</p>
<p>Backing up should be done with a script that can be called automatically once a day or so.
The following (saved in <code>/root/backup/backup.sh</code>) should be a good start: It backs up the forgejo data,
<code>/etc/</code> and <code>/root/</code> and optionally an <a href="https://www.openproject.org/">OpenProject</a> installation
(if you want to use that, uncomment the <code>#backupopenproject</code> line in <code>backupallthethings()</code>)<sup id="fnref:11"><a href="#fn:11" class="footnote-ref" role="doc-noteref">11</a></sup>.
It also checks if each command succeded, and if anything goes wrong sends you an E-Mail with further
information, and stores a log in <code>/root/backup/backuplog.txt</code>.</p>
<p>Remember to adjust the <code>export RESTIC_REPOSITORY=&quot;...&quot;</code> line, and <em>maybe</em> <code>WARN_MAIL_RECP=(...)</code>.</p>
<p><a href="../../../../downloads/backup.sh" download>Download backup.sh</a></p>
<details> <summary>Click to show the script</summary>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">RESTIC_REPOSITORY</span><span class="o">=</span><span class="s2">&#34;TODO_YOUR_RESTIC_REPO&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">RESTIC_PASSWORD_FILE</span><span class="o">=</span>/root/backup/.restic-pw.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># who will get an e-mail if some part of the backup has an error?</span>
</span></span><span class="line"><span class="cl"><span class="nv">WARN_MAIL_RECP</span><span class="o">=(</span><span class="s2">&#34;root&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># for a custom list (instead of &#34;everyone who roots mails are</span>
</span></span><span class="line"><span class="cl"><span class="c1"># redirected to in /etc/aliases&#34;), instead use:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#WARN_MAIL_RECP=(&#34;foo@bar.example&#34; &#34;fu@fara.example&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># NOTE: if you don&#39;t want any emails sent, use an empty list, like this:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#WARN_MAIL_RECP=()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">NUM_ERRORS</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># helper function, prints current time in format &#34;15:34:02&#34;</span>
</span></span><span class="line"><span class="cl">mytime<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    date +<span class="s1">&#39;%R:%S&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># helper function, called with an error string as argument</span>
</span></span><span class="line"><span class="cl"><span class="c1"># checks if the last run command was successful (returned 0)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># otherwise increments NUM_ERRORS and prints the given error string</span>
</span></span><span class="line"><span class="cl">checklastcommand<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">NUM_ERRORS</span><span class="o">=</span><span class="k">$((</span>NUM_ERRORS <span class="o">+</span> <span class="m">1</span><span class="k">))</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$*</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># backs up just the data from OpenProject (and postgresql),</span>
</span></span><span class="line"><span class="cl"><span class="c1"># feel free to remove this function if you don&#39;t use that</span>
</span></span><span class="line"><span class="cl"><span class="c1"># !! if you *do* use OpenProject, uncomment the call !!</span>
</span></span><span class="line"><span class="cl"><span class="c1"># !! to backupopenproject in backupallthethings()    !!</span>
</span></span><span class="line"><span class="cl"><span class="c1"># based on:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># https://www.openproject.org/docs/installation-and-operations/operation/backing-up/</span>
</span></span><span class="line"><span class="cl"><span class="c1"># https://www.openproject.org/docs/installation-and-operations/operation/restoring/</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (meaning, the restore instructions should work with this data,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  except you&#39;ll copy the directories from the backup instead</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  of extracting them from a .tar.gz)</span>
</span></span><span class="line"><span class="cl">backupopenproject<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -e <span class="s2">&#34;\n</span><span class="k">$(</span>mytime<span class="k">)</span><span class="s2"> Backing up OpenProject&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    systemctl stop openproject
</span></span><span class="line"><span class="cl">    checklastcommand <span class="s2">&#34;ERROR: Stopping OpenProject service failed!&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># remove old postgres-backup dir, recreate an empty one</span>
</span></span><span class="line"><span class="cl">    <span class="o">[</span> -e /tmp/postgres-backup/ <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -r /tmp/postgres-backup/
</span></span><span class="line"><span class="cl">    mkdir /tmp/postgres-backup
</span></span><span class="line"><span class="cl">    chown postgres:postgres /tmp/postgres-backup
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="k">$(</span>mytime<span class="k">)</span><span class="s2"> .. dumping PostgreSQL database for OpenProject backup&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># this line is like described in the openproject docs</span>
</span></span><span class="line"><span class="cl">    su -l postgres -c <span class="s2">&#34;pg_dump -U postgres -d openproject -x -O \
</span></span></span><span class="line"><span class="cl"><span class="s2">        &gt; /tmp/postgres-backup/openproject.sql&#34;</span>
</span></span><span class="line"><span class="cl">    checklastcommand <span class="s2">&#34;ERROR: pg_dump for openproject.sql failed!&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># this is just to be double-sure, so we have a backup of all postgres</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># tables, not just openproject (mostly redundant with openproject.sql,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># but whatever, it&#39;s not that big..)</span>
</span></span><span class="line"><span class="cl">    su -l postgres -c <span class="s2">&#34;pg_dumpall &gt; /tmp/postgres-backup/all.sql&#34;</span>
</span></span><span class="line"><span class="cl">    checklastcommand <span class="s2">&#34;ERROR: pg_dumpall for all.sql failed!&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="k">$(</span>mytime<span class="k">)</span><span class="s2"> .. backing up OpenProject files&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    restic backup /var/db/openproject/files/ /tmp/postgres-backup/
</span></span><span class="line"><span class="cl">    checklastcommand <span class="s2">&#34;ERROR: backing up OpenProject&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Note: we don&#39;t manage git/svn repos with openproject,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># so those steps from the official docs are missing</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># also: /etc/openproject/ is backed up as part of</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#       /etc/ in an earlier backup step</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    service openproject start
</span></span><span class="line"><span class="cl">    checklastcommand <span class="s2">&#34;ERROR: Starting OpenProject service failed!&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># does all backup steps, prints messages to stdout</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (commands called by it might also print to stderr)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># in function so we can easily redirect all output to a logfile</span>
</span></span><span class="line"><span class="cl">backupallthethings<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Running Backup at </span><span class="k">$(</span>date +<span class="s1">&#39;%F %R:%S&#39;</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -e <span class="s2">&#34;\n</span><span class="k">$(</span>mytime<span class="k">)</span><span class="s2"> Backing up /root/ and /etc/&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Debian/Ubuntu and -derivatives specific:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># create a list of currently installed packages that</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># contains the versions etc</span>
</span></span><span class="line"><span class="cl">    dpkg -l &gt; /root/backup/inst_packages.txt
</span></span><span class="line"><span class="cl">    <span class="c1"># create a second list of installed packages in a format suitable</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># for dpkg --set-selections (helpful when reinstalling a system:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  dpkg --set-selections &lt; dpkg_selections.txt</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  apt-get dselect-upgrade</span>
</span></span><span class="line"><span class="cl">    dpkg --get-selections &gt; /root/backup/dpkg_selections.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># backup all of /etc/, it&#39;s just a few MB and may come in handy</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># (also all of /root/, except for the cache folder which is</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#  actively used by restic when it&#39;s backing up)</span>
</span></span><span class="line"><span class="cl">    restic backup --exclude /root/.cache/ /root/ /etc/
</span></span><span class="line"><span class="cl">    checklastcommand <span class="s2">&#34;ERROR: restic failed backing up /root/ and /etc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">##### Forgejo #####</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -e <span class="s2">&#34;\n</span><span class="k">$(</span>mytime<span class="k">)</span><span class="s2"> Backing up Forgejo&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># TODO: somehow check if someone is currently pushing</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#       before stopping the service? how?</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># flush forgejos queues</span>
</span></span><span class="line"><span class="cl">    su -l git -c <span class="s2">&#34;forgejo -c /etc/forgejo/app.ini -w /var/lib/forgejo \
</span></span></span><span class="line"><span class="cl"><span class="s2">        manager flush-queues&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    checklastcommand <span class="s2">&#34;ERROR: Flushing forgejo queues failed!&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># stop the service, so we backup a consistent state</span>
</span></span><span class="line"><span class="cl">    systemctl stop forgejo
</span></span><span class="line"><span class="cl">    checklastcommand <span class="s2">&#34;ERROR: Stopping forgejo service failed!&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Note: when using forgejo with sqlite, this also backs up the database</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># if you use postgres or mysql/mariadb, you need to do that</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># in an extra step (as shown in backupopenproject())</span>
</span></span><span class="line"><span class="cl">    restic backup /var/lib/forgejo/
</span></span><span class="line"><span class="cl">    checklastcommand <span class="s2">&#34;ERROR: backing up /var/lib/forgejo failed!&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># we&#39;re done backing up forgejo, start the service again</span>
</span></span><span class="line"><span class="cl">    systemctl start forgejo
</span></span><span class="line"><span class="cl">    checklastcommand <span class="s2">&#34;ERROR: Starting forgejo service failed!&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">##### OpenProject #####</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># uncomment the next line if you&#39;re using OpenProject</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#backupopenproject</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -e <span class="s2">&#34;\n</span><span class="k">$(</span>mytime<span class="k">)</span><span class="s2"> Checking basic backup consistency with restic check&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Note: this does *not* read all the data on the backup server to ensure</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># that data files weren&#39;t damaged there (that would required downloading</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># it and thus take a long time and use up lots of traffic), but (AFAIK)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># only checks the metadata and probably the size of the stored files.</span>
</span></span><span class="line"><span class="cl">    restic check
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">      <span class="nv">NUM_ERRORS</span><span class="o">=</span><span class="k">$((</span>NUM_ERRORS <span class="o">+</span> <span class="m">1</span><span class="k">))</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> <span class="s2">&#34;ERROR: restic check failed!&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> <span class="s2">&#34;  *might* be harmless, see https://restic.readthedocs.io/en/v0.15.2/faq.html&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -e <span class="s2">&#34;\n</span><span class="k">$(</span>mytime<span class="k">)</span><span class="s2"> Backup done!\n&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## actual execution of this script starts here:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># if there already is a backuplog.txt (from last run)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># rename it to backuplog-old.txt</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -e /root/backup/backuplog.txt <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    mv /root/backup/backuplog.txt /root/backup/backuplog-old.txt
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="c1"># run the backupallthetings() function. its output is both</span>
</span></span><span class="line"><span class="cl"><span class="c1"># printed to stdout and written into backuplog.txt</span>
</span></span><span class="line"><span class="cl">backupallthethings 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> tee /root/backup/backuplog.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="nv">$NUM_ERRORS</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$NUM_ERRORS</span><span class="s2"> errors during backup!&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># if the list of mail recipients isn&#39;t emtpy,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># send them a mail about the error</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">WARN_MAIL_RECP</span><span class="p">[@]</span><span class="si">}</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Note: this redirects everything printed within {  }</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#   to backuperrmail.txt</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="nb">echo</span> -n <span class="s2">&#34;Subject: WARNING: </span><span class="nv">$NUM_ERRORS</span><span class="s2"> errors &#34;</span>
</span></span><span class="line"><span class="cl">          <span class="nb">echo</span> <span class="s2">&#34;happened when trying to backup </span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2">!\n&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="nb">echo</span> -e <span class="s2">&#34;Please see log below for details\n&#34;</span>
</span></span><span class="line"><span class="cl">          cat /root/backup/backuplog.txt
</span></span><span class="line"><span class="cl">        <span class="o">}</span> &gt; /tmp/backuperrmail.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        sendmail <span class="s2">&#34;</span><span class="si">${</span><span class="nv">WARN_MAIL_RECP</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> &lt; /tmp/backuperrmail.txt
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="nv">$NUM_ERRORS</span>
</span></span></code></pre></div></details>
<p>After saving this script at <code>/root/backup/backup.sh</code>, make it executable (for root):<br>
<code># chmod 700 /root/backup/backup.sh</code></p>
<p>Run it once to make sure it works (might take a while, especially if you&rsquo;ve already imported
bigger git repos):<br>
<code># /root/backup/backup.sh</code></p>
<h2 id="create-a-cronjob-to-do-a-backup-every-night">Create a cronjob to do a backup every night</h2>
<p>If the manual run worked, create a cronjob so it runs every night, by creating a file
<code>/etc/cron.d/my_backup</code> with the following contents:</p>
<pre tabindex="0"><code># prevent cron from sending mails about this script
# the script sends mails itself if something went wrong
MAILTO=&#34;&#34;
# every night at 05:03, do a backup
3 5 * * * root  /root/backup/backup.sh
</code></pre><p>the format is (copied from Ubuntu&rsquo;s /etc/crontab):</p>
<pre tabindex="0"><code>.---------------- minute (0 - 59)
|  .------------- hour (0 - 23)
|  |  .---------- day of month (1 - 31)
|  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
|  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
|  |  |  |  |
3  5  *  *  * user-name command to be executed
</code></pre><p>(<code>*</code> means &ldquo;any&rdquo;, in our case &ldquo;on any day of month in any month on any day of week&rdquo;,
see also <a href="https://manpages.ubuntu.com/manpages/focal/en/man5/crontab.5.html">man 5 crontab</a>)</p>
<h2 id="some-more-notes-on-restic">Some more notes on restic</h2>
<p>Some general restic tips:</p>
<ul>
<li><code>$ restic --help</code> (or just <code>restic -h</code>) shows available commands and generic flags,<br>
<code>$ restic subcommand --help</code> (e.g <code>$ restic ls --help</code>) shows information and flags for a subcommand.</li>
<li>The full documentation can be found <a href="https://restic.readthedocs.io/">here</a></li>
<li><code># restic generate --bash-completion /etc/bash_completion.d/restic</code><br>
Creates a bash-completion file for restic, so you can complete restic subcommands and arguments
by pressing tab (after running this, you need to log out and log in again for it to be used, or
run <code># source /etc/bash_completion.d/restic</code> to use it immediately).</li>
<li><code># restic snapshots --latest 10</code> shows the 10 most recent snapshots</li>
<li><code># restic mount /mnt</code> mounts the backup repository to <code>/mnt</code>, so you can browse the snapshots and
contained files there, and copy them to your server to restore a backup. <strong>Note</strong> that this command
might take some time until the mountpoint is usable, and it runs in the foreground - it will print
something this once it&rsquo;s ready:
<pre tabindex="0"><code>Now serving the repository at /mnt
Use another terminal or tool to browse the contents of this folder. 
When finished, quit with Ctrl-c here or umount the mountpoint.
</code></pre></li>
<li>To prevent your backup storage from growing indefinitely over time, you can tell restic to delete
old snapshots, for example <code># restic forget --keep-within 1y</code> deletes snapshots that are older than
a year. Apparently <code>restic forget</code> itself is pretty fast, but to actually delete the data you need
to call <code># restic prune</code> afterwards which deletes unreferenced objects from the backup repository
and might take a while (while <code>prune</code> is running you can&rsquo;t create new backups). After pruning, you
should run <code># restic check</code> to make that the repository isn&rsquo;t damaged. See also
<a href="https://restic.readthedocs.io/en/stable/060_forget.html">the restic docs on forget</a> and
<a href="https://restic.readthedocs.io/en/stable/045_working_with_repos.html#checking-integrity-and-consistency">on check</a>.<br>
You may want to run <code>forget</code> and <code>prune</code> every once in a while, either manually or maybe once
a week or so in a cronjob.</li>
</ul>
<h2 id="backing-up-the-backup">Backing up the backup</h2>
<p>If you consider <strong>ransomware</strong> that encrypts/destroys the data on your server a possible threat,
keep in mind that, if the ransomware gains root access, it can also access your backup storage, and
could <strong>destroy your backup</strong> (unless you&rsquo;re using some kind of append-only remote storage, where
existing data can&rsquo;t be modified or deleted - at least restics
<a href="https://github.com/restic/rest-server">rest-server</a> supports that mode with <code>--append-only</code>)<sup id="fnref:12"><a href="#fn:12" class="footnote-ref" role="doc-noteref">12</a></sup>.</p>
<p>To prevent that (or generally for an <strong>additional level of redundancy</strong>), you could <strong>mirror your backup
storage</strong>, for example locally on an USB drive (you can mount the backup storage locally with
<a href="https://rclone.org/commands/rclone_mount/">Rclone</a>). As restic never modifies existing files in the
backup repository (see <a href="https://github.com/restic/restic/blob/master/doc/design.rst">design document</a>),
you can just copy the mounted backup repo to your local backup drive with<br>
<code>$ cp -R -n /mnt/backuprepo/ /mnt/backupdisk/restic-backup/</code><br>
<code>-R</code> copies recursively (all the folders and files contained in <code>/mnt/backuprepo/</code>) and <code>-n</code> makes
sure that existing files aren&rsquo;t overwritten, so even if a file has been scrambled on your backup
server, you won&rsquo;t get that broken version in your local backup as long as you&rsquo;ve copied the a good
version of that file to your local backup before. <em>(This assumes that your <code>cp</code> supports <code>-n</code> - at
least the cp versions of Linux, FreeBSD, Git Bash for Windows and macOS support it; alternatively
see<sup id="fnref:13"><a href="#fn:13" class="footnote-ref" role="doc-noteref">13</a></sup> for robocopy on Windows.)</em></p>
<p>It&rsquo;s probably a good idea to call <code>restic check --read-data</code> on your local copy of the backup repo,
to make sure that it&rsquo;s consistent (<code>--read-data</code> actually reads all files and checks their checksums,
so it might take a while - but will be a lot faster with a local copy of the backup than with
a remote backup that&rsquo;s on a server, where all files need to be downloaded while doing this - yes,
this requires installing restic locally).<br>
Note that, due to only copying over new files from the backup repo, if you ran <code>restic forget</code> and
<code>restic prune</code> there, that won&rsquo;t free any space on your local mirror, so you may want to call
<code>restic forget</code> and <code>restic prune</code> on it as well, <em>though to be honest I&rsquo;m not sure if that could
get the real backup repo and the local clone into a state that&rsquo;s inconsistent with each other</em>.
Alternatively, <strong>if you&rsquo;re certain that your remote backup repo is (currently) in a good state</strong>,
you could do a proper sync that deletes files that only exist locally (or even delete the local
backup and copy everything again).</p>
<h1 id="keeping-the-server-updated">Keeping the server updated</h1>
<p>You should try to keep your server up-to-date, especially the parts that are facing the public
internet (the Linux kernel, SSH, WireGuard).</p>
<p>There two major ways to achieve this: a service that sends you a mail when updates are available,
so you can run them manually (<em>apticron</em>) - or one that installs security-updates automatically
(and possibly reboots the system afterwards, if needed - <em>unattended-upgrades</em>). You can also use both,
so security updates are installed automatically, and you get mails about normal updates to do them manually.</p>
<p>Both apticron and unattended-upgrades use the <code>mailx</code> program to send mails, so make sure it&rsquo;s
installed:<br>
<code>$ which mailx</code><br>
If that does <em>not</em> print something like <code>/usr/bin/mailx</code>, install it with:<br>
<code># apt install bsd-mailx</code><br>
(it will use sendmail to send the mails, if you followed the instructions above that will actually
happen with <code>dma</code>, using an external SMTP server)</p>
<h2 id="apticron-send-mail-if-updates-are-available">apticron - send mail if updates are available</h2>
<p>Install apticron (the version for systems using systemd):<br>
<code># apt install apticron-systemd</code></p>
<p>By default it sends mails to <code>root</code>, which, if you have followed
<a href="#redirect-local-mails-for-root-to-your-mail-account">the instructions above</a>,
are automatically forwarded to you and/or other people administrating this server.</p>
<p>If you want to <strong>customize</strong> this, copy apticron&rsquo;s default config to <code>/etc/apticron/</code>:<br>
<code># cp /usr/lib/apticron/apticron.conf /etc/apticron/</code><br>
and open <code>/etc/apticron/apticron.conf</code> in a text editor to adjust it to your needs.
You may want to change <code>EMAIL=&quot;root&quot;</code> to <code>EMAIL=&quot;yourname@example.com&quot;</code> (use your mail address,
of course), so the mails about updates go to your real E-Mail account where you can see them.
Take a look at the other options in the config (they&rsquo;re all described in comments); I personally
didn&rsquo;t change any of them, though the <code>CUSTOM_SUBJECT</code> option probably is useful to make filtering
those mails easier.</p>
<p>If you want to <strong>specify the exact time</strong> this runs, run<br>
<code># systemctl edit apticron.timer</code><br>
and edit it accordingly - see the unattended-upgrades footnote<sup id="fnref:14"><a href="#fn:14" class="footnote-ref" role="doc-noteref">14</a></sup> for an example.</p>
<h2 id="unattended-upgrades-install-security-updates-automatically">unattended-upgrades - install security updates automatically</h2>
<p>Install unattended-upgrades:<br>
<code># apt install unattended-upgrades</code></p>
<p>On Ubuntu (but not Debian), if you want to enable automatic reboots (when needed by the update),
you also need to install <code>update-notifier-common</code><sup id="fnref:15"><a href="#fn:15" class="footnote-ref" role="doc-noteref">15</a></sup>:<br>
<code># apt install update-notifier-common</code></p>
<p>Apparently it must be enabled by reconfiguring it:<br>
<code># dpkg-reconfigure --priority=low unattended-upgrades</code> (select <code>&lt;Yes&gt;</code>)</p>
<p>Edit (as root) <code>/etc/apt/apt.conf.d/50unattended-upgrades</code> for further configuration:</p>
<ul>
<li>Find the line <code>//Unattended-Upgrade::Mail &quot;&quot;;</code>, uncomment it and set the <code>root</code> as E-Mail address
so all admins receive reports: <code>Unattended-Upgrade::Mail &quot;root&quot;;</code><br>
<em>(or, if you haven&rsquo;t <a href="#redirect-local-mails-for-root-to-your-mail-account">set up /etc/aliases</a>,
use your proper mail address: <code>Unattended-Upgrade::Mail &quot;yourname@example.com&quot;;</code>)</em></li>
<li>Below it, change <code>//Unattended-Upgrade::MailReport &quot;on-change&quot;;</code> to
<code>Unattended-Upgrade::MailReport &quot;on-change&quot;;</code> (or possibly <code>&quot;only-on-error&quot;</code> if you prefer that)</li>
<li>To enable automatic reboots, replace the line <code>//Unattended-Upgrade::Automatic-Reboot &quot;false&quot;;</code>
with <code>Unattended-Upgrade::Automatic-Reboot &quot;true&quot;;</code></li>
<li>If you enabled automatic reboots, to specify at what time they should happen (the default is &ldquo;now&rdquo;,
immediately after installing an update that needs it), you can set:<br>
<code>Unattended-Upgrade::Automatic-Reboot-Time &quot;02:00&quot;;</code><br>
(that would be for 2am) - might make more sense to modify the systemd timers that control when
updates are installed and leave this commented out<sup id="fnref1:14"><a href="#fn:14" class="footnote-ref" role="doc-noteref">14</a></sup>.</li>
</ul>
<blockquote>
<p><strong>NOTE:</strong> If you don&rsquo;t want unattended-upgrades to reboot your system, but want to get a mail
telling you to reboot instead, that unfortunately isn&rsquo;t supported out of the box, but you
can write a custom script that checks if <code>/var/run/reboot-required</code> exists and
<a href="#testing-the-sendmail-command">sends an E-Mail</a>.
See also <a href="https://askubuntu.com/a/540973">this post on Ask Ubuntu</a>.</p>
</blockquote>
<p>For further information on unattended-upgrades, see the articles in the
<a href="https://wiki.debian.org/UnattendedUpgrades">Debian Wiki</a> and
<a href="https://help.ubuntu.com/community/AutomaticSecurityUpdates#Using_the_.22unattended-upgrades.22_package">Ubuntu Wiki</a>
and <a href="https://haydenjames.io/how-to-enable-unattended-upgrades-on-ubuntu-debian/">this blogpost</a>.</p>
<h1 id="some-basic-monitoring">Some basic monitoring</h1>
<p>It&rsquo;s useful to get an E-Mail if your server&rsquo;s CPU is unusually loaded or the main
memory is (almost) full or the hard disk is running out of space, so you can investigate those
issues, hopefully before they make the server unusable.</p>
<p>I haven&rsquo;t found a good existing solution for this (<a href="https://www.nagios.org/">Nagios</a> etc are
for complex systems consisting of big networks with many servers and thus seemed like complete
overkill for a single server), so I decided to write a simple bash script to do this myself.</p>
<p>It needs <code>bc</code>, so install it:<br>
<code># apt install bc</code></p>
<p>This is the result, save as <code>/root/scripts/monitoring.sh</code>:<br>
<a href="../../../../downloads/monitoring.sh" download>Download monitoring.sh</a></p>
<details> <summary>Click to show the script</summary>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># who gets an email for new warnings?</span>
</span></span><span class="line"><span class="cl"><span class="nv">WARN_MAIL_RECP</span><span class="o">=(</span><span class="s2">&#34;root&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># for a custom list (instead of &#34;everyone who roots mails are</span>
</span></span><span class="line"><span class="cl"><span class="c1"># redirected to in /etc/aliases&#34;), instead use:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#WARN_MAIL_RECP=(&#34;foo@bar.example&#34; &#34;fu@fara.example&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># NOTE: if you don&#39;t want any emails sent, use an empty list,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># like in the next line</span>
</span></span><span class="line"><span class="cl"><span class="c1">#WARN_MAIL_RECP=()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># NOTE: adjust this to your server - ours has 16GB of RAM</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  and no swap, so if it runs below 900MB that&#39;s probably not good,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  but if yours only has 2GB or so, you&#39;ll want a lower limit</span>
</span></span><span class="line"><span class="cl"><span class="nv">LOW_MEM_WARNING_THRESHOLD</span><span class="o">=</span><span class="m">900</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">NUM_NEW_WARNINGS</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">NEW_CPU_WARNING</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">NEW_MEM_WARNING</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">NEW_DISK_WARNING</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">create_report<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Running monitoring script at </span><span class="k">$(</span>date +<span class="s1">&#39;%F %R:%S&#39;</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">NUM_CPU_CORES</span><span class="o">=</span><span class="k">$(</span>grep -c <span class="s2">&#34;cpu MHz&#34;</span> /proc/cpuinfo<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">read</span> -r _ _ avg15min rest <span class="o">&lt;&lt;&lt;</span> <span class="s2">&#34;</span><span class="k">$(</span>cat /proc/loadavg<span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">AVG_PER_CORE</span><span class="o">=</span><span class="k">$(</span>bc -l <span class="o">&lt;&lt;&lt;</span> <span class="s2">&#34;</span><span class="nv">$avg15min</span><span class="s2"> / </span><span class="nv">$NUM_CPU_CORES</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="k">$(</span>bc -l <span class="o">&lt;&lt;&lt;</span> <span class="s2">&#34;</span><span class="nv">$AVG_PER_CORE</span><span class="s2"> &gt; 0.95&#34;</span><span class="k">)</span> <span class="o">=</span> <span class="s2">&#34;1&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">NEW_CPU_WARNING</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;High load in last 15 minutes: </span><span class="nv">$AVG_PER_CORE</span><span class="s2"> per core!&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Details from top:&#34;</span>
</span></span><span class="line"><span class="cl">        top -b -n <span class="m">1</span> -o <span class="s2">&#34;%CPU&#34;</span> -c -w <span class="m">512</span> <span class="p">|</span> head -n <span class="m">20</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="c1"># add empty line</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># /proc/meminfo has values in KB, convert to MB</span>
</span></span><span class="line"><span class="cl">    <span class="nv">MEM_AVAILABLE_KB</span><span class="o">=</span><span class="k">$(</span>grep <span class="s2">&#34;MemAvailable:&#34;</span> /proc/meminfo <span class="p">|</span> grep -o <span class="s2">&#34;[0-9]*&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">MEM_AVAILABLE</span><span class="o">=</span><span class="k">$((</span> MEM_AVAILABLE_KB <span class="o">/</span> <span class="m">1000</span> <span class="k">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$MEM_AVAILABLE</span><span class="s2">&#34;</span> -lt <span class="nv">$LOW_MEM_WARNING_THRESHOLD</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">NEW_MEM_WARNING</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;low on main memory, only </span><span class="nv">$MEM_AVAILABLE</span><span class="s2"> MB left!&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;free -m:&#34;</span>
</span></span><span class="line"><span class="cl">        free -m
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Biggest offenders:&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#ps aux --sort=-%mem | head</span>
</span></span><span class="line"><span class="cl">        top -b -n <span class="m">1</span> -o <span class="s2">&#34;%MEM&#34;</span> -c -w <span class="m">512</span> <span class="p">|</span> head -n <span class="m">20</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="c1"># add empty line</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">DISKUSE_PERC</span><span class="o">=</span><span class="k">$(</span>df --output<span class="o">=</span>pcent / <span class="p">|</span> tail -n <span class="m">1</span> <span class="p">|</span> grep -o <span class="s2">&#34;[0-9]*&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$DISKUSE_PERC</span><span class="s2">&#34;</span> -gt <span class="m">85</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">NEW_DISK_WARNING</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;Disk is getting full, already </span><span class="nv">$DISKUSE_PERC</span><span class="s2"> percent used!&#34;</span>
</span></span><span class="line"><span class="cl">        lsblk -e <span class="m">7</span> -T -o NAME,TYPE,FSTYPE,MOUNTPOINT,SIZE,FSSIZE,FSAVAIL,FSUSE%
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> -e <span class="s2">&#34;\nBiggest offenders:&#34;</span>
</span></span><span class="line"><span class="cl">        du -h --max-depth<span class="o">=</span><span class="m">6</span> -x / <span class="p">|</span> sort -h -r <span class="p">|</span> head -n <span class="m">20</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="c1"># add empty line</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># TODO: what else could I check? some way to check for random errors? logs?</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nv">NUM_NEW_WARNINGS</span><span class="o">=</span><span class="k">$((</span>NEW_CPU_WARNING <span class="o">+</span> NEW_MEM_WARNING <span class="o">+</span> NEW_DISK_WARNING<span class="k">))</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">send_alert_mail<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Sending an alert mail&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> -n <span class="s2">&#34;Subject: Alert: </span><span class="nv">$NUM_NEW_WARNINGS</span><span class="s2"> &#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> -e <span class="s2">&#34;warnings while monitoring </span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2">!\n&#34;</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> -e <span class="s2">&#34;Please see log below for details\n&#34;</span>
</span></span><span class="line"><span class="cl">      cat /root/monitorlog.txt
</span></span><span class="line"><span class="cl">    <span class="o">}</span> &gt; /tmp/monitormail.txt
</span></span><span class="line"><span class="cl">    sendmail <span class="s2">&#34;</span><span class="si">${</span><span class="nv">WARN_MAIL_RECP</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> &lt; /tmp/monitormail.txt
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> <span class="s2">&#34;# this file is used by monitor.sh&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> <span class="s2">&#34;# to check which warnings are new&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># unix timestamp from now (seconds since Epoch)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> <span class="s2">&#34;LAST_MAILTIME=</span><span class="k">$(</span>date +<span class="s1">&#39;%s&#39;</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> <span class="s2">&#34;LAST_CPU_WARNING=</span><span class="nv">$NEW_CPU_WARNING</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> <span class="s2">&#34;LAST_MEM_WARNING=</span><span class="nv">$NEW_MEM_WARNING</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> <span class="s2">&#34;LAST_DISK_WARNING=</span><span class="nv">$NEW_DISK_WARNING</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> &gt; /tmp/lastmonitormailstate.sh
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## actual execution of this script starts here:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">create_report 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> tee /root/monitorlog.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="nv">$NUM_NEW_WARNINGS</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Alert! </span><span class="nv">$NUM_NEW_WARNINGS</span><span class="s2"> new Warnings!&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> <span class="s2">&#34;# this file is used by monitor.sh&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> <span class="s2">&#34;# to see for how long the system has been in a \&#34;bad\&#34; state&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> <span class="s2">&#34;LAST_BAD_CHECK_TIME=</span><span class="k">$(</span>date +<span class="s1">&#39;%s&#39;</span><span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> &gt; /tmp/lastmonitorbadcheck.sh
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">WARN_MAIL_RECP</span><span class="p">[@]</span><span class="si">}</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[</span> ! -f /tmp/lastmonitormailstate.sh <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># no monitoring alert mail sent yet (since last reboot),</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># just send one now</span>
</span></span><span class="line"><span class="cl">            send_alert_mail
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># we already sent a warning, only send a new one if there  </span>
</span></span><span class="line"><span class="cl">            <span class="c1"># are new warnings or the old one was sent too long ago (&gt;12h)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="c1"># source lastmonitormailstate.sh to get LAST_* with</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># the state from last time we sent an alert mail</span>
</span></span><span class="line"><span class="cl">            . /tmp/lastmonitormailstate.sh
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="nv">NOW_TIME</span><span class="o">=</span><span class="k">$(</span>date +<span class="s1">&#39;%s&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">            <span class="nv">SECONDS_SINCE_LAST_MAIL</span><span class="o">=</span><span class="k">$((</span>NOW_TIME <span class="o">-</span> LAST_MAILTIME<span class="k">))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 12h * 60min * 60sec = 43200 sec</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">[</span> <span class="nv">$SECONDS_SINCE_LAST_MAIL</span> -gt <span class="m">43200</span> <span class="o">]</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              <span class="o">||</span> <span class="o">[</span> <span class="nv">$NEW_CPU_WARNING</span> -gt <span class="nv">$LAST_CPU_WARNING</span> <span class="o">]</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              <span class="o">||</span> <span class="o">[</span> <span class="nv">$NEW_MEM_WARNING</span> -gt <span class="nv">$LAST_MEM_WARNING</span> <span class="o">]</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              <span class="o">||</span> <span class="o">[</span> <span class="nv">$NEW_DISK_WARNING</span> -gt <span class="nv">$LAST_DISK_WARNING</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">then</span>
</span></span><span class="line"><span class="cl">                send_alert_mail
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span> <span class="c1"># WARN_MAIL_RECP not empty</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="o">[</span> -f /tmp/lastmonitorbadcheck.sh <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># there were no warnings, but lastmonitorbadcheck.sh exists,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># so there were warnings before. if the last bad check was</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># long enough ago, delete lastmonitorbadcheck.sh</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># so if a new warning (that&#39;s probably unrelated to the old one)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># happens, a new mail is sent</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    . /tmp/lastmonitorbadcheck.sh
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nv">NOW_TIME</span><span class="o">=</span><span class="k">$(</span>date +<span class="s1">&#39;%s&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">SECONDS_SINCE_LAST_MAIL</span><span class="o">=</span><span class="k">$((</span>NOW_TIME <span class="o">-</span> LAST_BAD_CHECK_TIME<span class="k">))</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 60min*60sec = 3600sec</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$SECONDS_SINCE_LAST_MAIL</span> -gt <span class="m">3600</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        rm /tmp/lastmonitorbadcheck.sh
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="nv">$NUM_NEW_WARNINGS</span>
</span></span></code></pre></div></details>
<p>make the script executable:<br>
<code># chmod 755 /root/scripts/monitoring.sh</code></p>
<p>Create a cronjob to run the monitoring script every 10 minutes, by creating a file
<code>/etc/cron.d/my_monitoring</code> with the following contents:</p>
<pre tabindex="0"><code># prevent cron from sending mails about this script
# the script sends mails itself if it detected a problem
MAILTO=&#34;&#34;
# run the monitoring script every 10 minutes
*/10 * * * * root  /root/scripts/monitoring.sh
</code></pre><blockquote>
<p><strong>NOTE:</strong> If you&rsquo;re using a &ldquo;real&rdquo;/dedicated server (instead of a virtual machine/VPS),
you should probably also use and
<a href="https://manpages.ubuntu.com/manpages/jammy/man5/smartd.conf.5.html">configure</a> <code>smartd</code> from the
<code>smartmontools</code> package to get E-Mails about
<a href="https://en.wikipedia.org/w/index.php?title=Self-Monitoring,_Analysis_and_Reporting_Technology">SMART</a>
disk warnings/errors, and possibly something that checks the server&rsquo;s temperature sensors
(for example by scripting something based on <code>lm_sensors</code>)</p>
</blockquote>
<h1 id="bonus-openproject">Bonus: OpenProject</h1>
<p>I&rsquo;ll keep this short(ish), I just thought I&rsquo;d mention it as I installed it on our server because we
wanted to try it out.</p>
<p>Before the actual installation, add an entry for <code>openproject.example.lan</code> to <code>/etc/hosts</code>
(a line like <code>172.30.0.1  openproject.example.lan</code>) and restart <code>dnsmasq</code>
(<code># systemctl restart dnsmasq.service</code>).</p>
<p>Basically, follow the
<a href="https://www.openproject.org/docs/installation-and-operations/installation/packaged/#ubuntu-2204">official installation instructions for Ubuntu 22.04</a>
and then the
<a href="https://www.openproject.org/docs/installation-and-operations/installation/packaged/#initial-configuration">initial configuration guide</a>.</p>
<p><strong>HOWEVER</strong>, some specialties:</p>
<ul>
<li>The instructions to import the PGP key for the apt repo are using the deprecated <code>apt-key</code> tool.
Better alternative:<br>
<code># wget -O /etc/apt/trusted.gpg.d/openproject.asc https://dl.packager.io/srv/opf/openproject/key</code></li>
<li><strong>Do <em>not</em> install the Apache2</strong> web server! (We&rsquo;ll use nginx) =&gt; select <code>skip</code> in that step</li>
<li>As &ldquo;server/hostname&rdquo; select <code>openproject.example.lan</code> (or whatever you added to <code>/etc/hosts</code>
before the installation)</li>
<li><strong>Do <em>not</em> enable SSL</strong>!</li>
<li><strong><em>Skip</em> the Subversion (SVN) and Git support</strong> (according to the documentation they require Apache)</li>
</ul>
<p>Once that&rsquo;s done, <strong>make sure that SSL <em>really</em> is disabled</strong> (it wasn&rsquo;t for me, I&rsquo;m not sure if I
accidentally chose the wrong option in the configuration or if there was a bug). To do that, open
<code>/etc/openproject/conf.d/other</code> in a text editor and check if
<code>export OPENPROJECT_HTTPS=&quot;false&quot;</code> and <code>export OPENPROJECT_HSTS=&quot;false&quot;</code> are indeed set to <code>&quot;false&quot;</code>.
If they aren&rsquo;t, change them accordingly, afterwards restart OpenProject:<br>
<code># systemctl restart openproject.service</code></p>
<p>Now configure <strong>nginx</strong> to redirect <code>openproject.example.lan</code> to the OpenProject service, which
listens on <code>localhost:6000</code>. Create the file <code>/etc/nginx/sites-available/openproject</code>
with the following contents:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># only listen on the WireGuard VPN IP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">listen</span> <span class="n">172.30.0.1</span><span class="p">:</span><span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server_name</span> <span class="s">openproject.example.lan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">root</span> <span class="s">/opt/openproject/public</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># allow more than 1MB for uploads
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">client_max_body_size</span> <span class="mi">64m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="p">~</span> <span class="sr">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_pass_request_headers</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Host</span> <span class="nv">$host:$server_port</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Server</span> <span class="nv">$host:$server_port</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:6000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Create a symlink to <code>/etc/nginx/sites-enabled/</code>:<br>
<code># ln -s /etc/nginx/sites-available/openproject /etc/nginx/sites-enabled/</code><br>
and restart nginx:<br>
<code># systemctl restart nginx.service</code></p>
<p>Now you should be able to access and configure OpenProject in the browser,
under <a href="http://openproject.example.lan">http://openproject.example.lan</a>.</p>
<p>See the <a href="https://www.openproject.org/docs/system-admin-guide/">OpenProject System admin guide</a> for
more information on administrating it, and the <a href="https://www.openproject.org/docs/user-guide/">user guide</a>
for information on using it.</p>
<p>You can configure the E-Mail settings at <code>Administration</code> -&gt; <code>Emails and notification</code> -&gt;
<code>Email notifications</code>. The &ldquo;Emission email address&rdquo; should be something like
<code>OpenProject &lt;noreply@yourdomain.com&gt;</code>, the &ldquo;Email delivery method&rdquo; should be <code>sendmail</code> and the
&ldquo;Location of the sendmail executable&rdquo; is <code>/usr/sbin/sendmail</code>. Save and then click &ldquo;Send a test email&rdquo;
to test it.</p>
<p>The <a href="#actually-backing-up"><strong>backup</strong> script above</a> is already prepared for OpenProject, the only
thing you need to do is to <strong>uncomment</strong> the <code>#backupopenproject</code> line in <code>backupallthethings()</code> by
removing the <code>#</code> at the beginning of the line.</p>
<h1 id="thanks">Thanks</h1>
<p>Thank you for reading this, I hope you found it helpful!</p>
<p>Thanks to <a href="https://www.masterbrainbytes.com/">my employer</a> for letting me turn the documentation
for setting up our server into a proper blog post.</p>
<p>Thanks to <a href="https://www.yamagi.org/">Yamagi</a> for proofreading this and answering my stupid questions
about server administration :-)</p>
<!-- Below: Footnotes -->
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>As a <strong>server</strong> we chose the <a href="https://contabo.com/">Contabo</a> &ldquo;Cloud VPS M&rdquo; for €10.49/month,
which has more CPU power and RAM than we need, a 400GB SSD, and supports snapshots (their &ldquo;Storage VPS&rdquo;
line, that has even more storage but less CPU power and RAM, doesn&rsquo;t), which seems pretty useful to
easily restore the system if an update goes wrong or similar. They also allow upgrading to a bigger
VPS (with more CPU, RAM and storage) later without having to reinstall (unless you switch between
normal VPS and &ldquo;Storage VPS&rdquo;).<br>
Furthermore, they offer S3-compatible Object Storage with unlimited traffic for €2.49 per 250GB per month,
which is <em>very</em> cheap. Unfortunately we found the performance of the Contabo Object Storage unsatisfying,
especially uploading was a bit slow: Usually between 2.5 and 4.5 MByte/s, but sometimes below 1 MB/s,
for the whole upload duration of ~1GB file.. I hope this improves in the future, for now the &ldquo;SSD&rdquo;
storage of the VPS is big enough for our usecase, so we use that - only if we end up needing
more than 3TB storage their available VPSs stop scaling and we&rsquo;ll have to look more seriously at
their Object Storage offerings..<br>
Either way this is <em>not</em> an endorsement for Contabo, we haven&rsquo;t used them for long enough to judge
the overall quality of their service, and this Howto should work with any Linux server (VPS or dedicated).
FWIW, the performance of the VPS itself has been fine so far.<br>
Some other low-cost hosters I have at least a little (positive) experience with include
<a href="https://www.hetzner.com/">Hetzner</a> (they offer dedicated servers for &lt; €50/month)
and <a href="https://www.vultr.com/">vultr</a> (they also offer cheap S3-compatible Object Storage, but
I don&rsquo;t know if their performance is better than Contabos..).<br>
I can absolutely <strong>not</strong> recommend OVH, as their customers had to learn
<a href="https://blocksandfiles.com/2023/03/23/ovh-cloud-must-pay-damages-for-lost-backup-data/">the hard way</a>
that OVH data centers are built out of wood and backups are stored in the same building as the
backed up servers, so if a fire breaks out, it burns well and both the servers and the backups
get destroyed.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>At least that&rsquo;s what one of the developers told me in the Forgejo chatroom.
Apparently even <a href="https://try.gitea.io/">https://try.gitea.io/</a> uses sqlite, so it might be fine even with lots of repos
and users.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>At least &ldquo;reasonably safe&rdquo;. There is no total security. It&rsquo;s possible that OpenSSH, WireGuard
or the Linux kernels network stack have unknown security vulnerabilities that an attacker could
exploit to get onto your server. It&rsquo;s also possible that your hosters infrastructure gets
compromised and attackers get access to the servers (via hypervisor for VPS, or remote consoles
for dedicated servers, or even physically by breaking in).<br>
And of course it&rsquo;s possible (I&rsquo;d even say more likely than some of the scenarios mentioned before)
that someone hacks <em>your</em> PC and gets access to the server and/or your git repos that way.<br>
Anyway, if you follow this guide (and hopefully keep at least the Linux kernel, WireGuard and
OpenSSH up to date), your data will be <em>a lot</em> safer than it would be if you exposed webservices
(instead of just WireGuard and SSH) to the internet.&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>I&rsquo;ve never done this, but it might be possible to give a client some more
IPs with a different subnet mask, but that&rsquo;s not useful for this usecase and you&rsquo;d still have to
make sure that there&rsquo;s no overlaps with IPs assigned to other clients.&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p>If you&rsquo;re wondering why I&rsquo;m using iptables and not UFW or
<a href="https://netfilter.org/projects/nftables/">nftables</a>, the answer is simple and boring:
I&rsquo;m not familiar with UFW or nftables, but I&rsquo;m familiar with iptables, so using iptables
was easiest for me <code>¯\_(ツ)_/¯</code>. If you&rsquo;re more familiar with an alternative, feel free to
use that to create equivalent rules.&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p>If you&rsquo;re not sure what the network device on your server is called, run <code>$ ip address</code>
in the terminal. It will list all network devices (including loopback <code>lo</code> and your WireGuard
device <code>wg0</code> if it&rsquo;s currently up). The device with the public internet IP that you&rsquo;re also
using to connect to the server via SSH/WireGuard is the one you need.&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7">
<p>Sometimes using a custom top level domain (TLD) is discouraged, because (unlike a few years back)
nowadays, with enough money, one can register arbitrary TLDs that don&rsquo;t exist yet.<br>
However, .lan is relatively widely used for this purpose, for example by OpenWRT, and
<a href="https://icannwiki.org/Name_Collision">https://icannwiki.org/Name_Collision</a> shows that ICANN is aware that letting someone register
.lan would be a bad idea. Furthermore, there even is an RFC that <em>almost</em> recommends using .lan,
so I think it should be safe (&ldquo;almost&rdquo; as in <a href="https://www.rfc-editor.org/rfc/rfc6762.html#appendix-G"><em>&ldquo;We do not recommend use of unregistered top-level
at all, but should network operators decide to do this, the following top-level domains have been
used on private internal networks (&hellip;) for this purpose: .intranet, .internal, .private, .corp,
.home, <strong>.lan</strong>&rdquo;</em></a>).<br>
Do <strong>not</strong> use <strong>.local</strong>, it&rsquo;s <a href="https://en.wikipedia.org/wiki/.local">reserved for multicast DNS / zeroconf (avahi, bonjour)</a>
and using it as a TLD for normal DNS just causes headaches (will need explicit configuration on
many clients to work, because by default they assume that it&rsquo;s mDNS-only).&#160;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:8">
<p>In <strong>Firefox</strong> you can fix this issue by opening <code>about:config</code> (enter that in
the URL bar), and then in the search field enter <code>browser.fixup.domainsuffixwhitelist.lan</code>, select
<code>Boolean</code> and press the <code>[+]</code> button on the right to add the setting, make sure it&rsquo;s set to <code>true</code>.<br>
For <strong>Chrome</strong> (and probably in derived browsers like Edge and modern Opera and whatever),
there is no good workaround AFAIK.
<a href="https://superuser.com/questions/274562/teach-google-chrome-to-understand-custom-tld">Apparently</a>
you can teach it to always treat things typed into the URL bar as search terms, but then that
doesn&rsquo;t only affect example.lan (or *.lan), but all search terms, so to search you&rsquo;d either
have to press Ctrl-K before typing, or type <code>? </code> before your search term (like
<code>? why are computers so horrible</code>). Alternatively, it helps if you add a slash, like
<code>git.example.lan/</code> instead of just <code>git.example.lan</code> - that&rsquo;s easier to type than
<code>http://git.example.lan</code> (though once the browser knows the URL you should get the version with
http:// anyway through autocompletion).&#160;<a href="#fnref:8" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:9">
<p>&hellip; so what!&#160;<a href="#fnref:9" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:10">
<p>Some examples for comparison:</p>
<ul>
<li><a href="https://aws.amazon.com/s3/pricing/">Amazon S3</a> $21/month for 1TB of storage, $90/TB for
<em>downloading</em> traffic (uploading is free), requests cost extra</li>
<li><a href="https://www.backblaze.com/b2/cloud-storage.html">Backblaze B2</a> $5/month for 1TB of storage and
$10 per <strong>downloaded</strong> TB (uploads seem to be free?).</li>
<li><a href="https://contabo.com/en/object-storage/">Contabo</a> around €10/month for 1TB, incl. traffic.
They say that they <a href="https://docs.contabo.com/docs/products/Object-Storage/technical-description/#limits">throttle bandwidth to 80MBit/s (10MByte/s)</a>,
but in my tests (this is the only provider I tested), especially uploads were even slower:
Usually between 2.5 and 4.5 MByte/s, often below 1.5 MByte/s. Maybe that improves in the
future, but in the two weeks or so that I&rsquo;ve (occasionally) done tests, it was like this.</li>
<li><a href="https://www.vultr.com/products/object-storage/">Vultr</a> $5/month for 1TB of storage and
1TB of traffic, each additional TB of storage costs $5/month, each additional TB of traffic
costs $10/month</li>
</ul>
&#160;<a href="#fnref:10" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></li>
<li id="fn:11">
<p>Even if you&rsquo;re not using OpenProject, it shows how to backup PostgreSQL databases, which
might come in handy elsewhere. <strong>NOTE:</strong> It might be useful to additionally/manually run
<code># su -l postgres -c &quot;pg_basebackup -D /tmp/postgres-base/ -R&quot;</code> once to get a base backup that
can easily restore the whole postgres setup (I think) - just put /tmp/postgres-base/ in a tar
archive and store that in /root/ somewhere so it&rsquo;s backed up with the regular backups.<br>
I <em>think</em> that such a base backup together with the normal SQL dumps from the daily backup make
restoring the PostgreSQL server relatively easy, but TBH I haven&rsquo;t tried it myself yet and
the pg_basebackup manpage unfortunately doesn&rsquo;t document how this is done..<br>
<strong>TODO:</strong> how do I restore a pg_basebackup?&#160;<a href="#fnref:11" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:12">
<p>You could run restic&rsquo;s <a href="https://github.com/restic/rest-server">rest-server</a>
(in <code>--append-only</code> mode) on a backupserver at home (or in your office), and make that
backupserver connect to your WireGuard VPN, so it can be easily reached from the git server.
And &ldquo;backupserver&rdquo; could just be a Raspberry Pi<sup id="fnref:16"><a href="#fn:16" class="footnote-ref" role="doc-noteref">16</a></sup> with with a big USB harddrive.&#160;<a href="#fnref:12" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:13">
<p>If you&rsquo;re using Windows and don&rsquo;t have Git Bash installed, you can <em>probably</em> use
robocopy, like this (<strong>untested!</strong>; assuming <code>X:</code> is your mounted restic repo and <code>D:</code> is you backup disk):<br>
<code>&gt; robocopy X:\ D:\restic-backup\ /XC /XN /XO</code></p>
<ul>
<li><code>/XC</code> means &ldquo;don&rsquo;t copy (&ldquo;e<strong>X</strong>clude&rdquo;) files that are <strong>C</strong>hanged (have different size) in
the destination, but have the same timestamp</li>
<li><code>/XN</code> means &ldquo;don&rsquo;t copy files that have a <strong>N</strong>ewer timestamp in the destination than in the source&rdquo;</li>
<li><code>/XO</code> means &ldquo;don&rsquo;t copy files that have a <strong>O</strong>lder timestamp in the destination than in the source&rdquo;</li>
<li>=&gt; those three options together should hopefully make sure that only files that don&rsquo;t exist
on your backup disk at all are copied from the restic repository</li>
</ul>
&#160;<a href="#fnref:13" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></li>
<li id="fn:14">
<p>According to <a href="https://wiki.debian.org/UnattendedUpgrades#Modifying_download_and_upgrade_schedules_.28on_systemd.29">the Debian Wiki</a>
updates are downloaded by the systemd <code>apt-daily.timer</code> and installed (upgrade) by the
<code>apt-daily-upgrade.timer</code>, and apparently by default they happen at 6am or 6pm with a randomized
delay of 12h.. I think this means they happen pretty much randomly, the download part maybe even
twice a day, the upgrade/install part once a day.<br>
Might make sense to at least modify the upgrade timer (<code># systemctl edit apt-daily-upgrade.timer</code>,
afterwards <code># systemctl restart apt-daily-upgrade.timer</code>)
to make sure that the installation of packages and possible reboot afterwards don&rsquo;t interfere
with scheduled backups or people who want to use the server for work, I used this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-systemd" data-lang="systemd"><span class="line"><span class="cl"><span class="c"># define the time when unattended-upgrades upgrades packages</span>
</span></span><span class="line"><span class="cl"><span class="c"># (and possibly reboots afterwards),</span>
</span></span><span class="line"><span class="cl"><span class="c"># to prevent conflicts with the backup script (that starts at 05:03)</span>
</span></span><span class="line"><span class="cl"><span class="k">[Timer]</span>
</span></span><span class="line"><span class="cl"><span class="c"># the following line resets the default value from</span>
</span></span><span class="line"><span class="cl"><span class="c"># /lib/systemd/system/apt-daily-upgrade.timer</span>
</span></span><span class="line"><span class="cl"><span class="na">OnCalendar</span><span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="c"># now we can specify the actual time</span>
</span></span><span class="line"><span class="cl"><span class="c"># (around 4pm, note that the backup starts shortly after 5am)</span>
</span></span><span class="line"><span class="cl"><span class="na">OnCalendar</span><span class="o">=</span><span class="s">03:55</span>
</span></span><span class="line"><span class="cl"><span class="c"># Overwrite the randomized delay set by default,</span>
</span></span><span class="line"><span class="cl"><span class="c"># so it happens exactly at that time</span>
</span></span><span class="line"><span class="cl"><span class="na">RandomizedDelaySec</span><span class="o">=</span><span class="s">0</span>
</span></span></code></pre></div>&#160;<a href="#fnref:14" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:14" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></li>
<li id="fn:15">
<p>At least that&rsquo;s what the
<a href="https://help.ubuntu.com/community/AutomaticSecurityUpdates#Using_the_.22unattended-upgrades.22_package">Ubuntu Wiki on Automatic Security Updates</a>
says:</p>
<blockquote>
<p>If you want the script to automatically reboot when needed, you not only need to set
Unattended-Upgrade::Automatic-Reboot &ldquo;true&rdquo;, but you also need to have the &ldquo;update-notifier-common&rdquo;
package installed.</p>
</blockquote>
<p>Debian on the other hand doesn&rsquo;t even have a package with that name.&#160;<a href="#fnref:15" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:16">
<p>Yeah yeah, I know&hellip; I&rsquo;m sure they&rsquo;ll eventually be available at normal prices again.<br>
Or maybe you already got one, or try a Banana Pi or RockPi or whatever.&#160;<a href="#fnref:16" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
    </div>
  </article>

  

  <hr>

  <div id="gh-comments">
    <h4>COMMENTS</h4>
    <div id="gh-comments-list"></div>
    <a href="javascript:void(0)" id="gh-load-comments" class="btn" style="display:none">Load more comments</a>
    <noscript>
      <a href="https://github.com/DanielGibson/DanielGibson.github.io/issues/13"
         target='_blank' class='btn'>(Javascript is disabled)<br>View Comments on Github</a>
    </noscript>
  </div>

  <script type="text/javascript" src="../../../../js/github-comments.js"></script>
  <script type="text/javascript">
    DoGithubComments( 13 );
  </script>
  

</main>

      <footer class="footer">
        <ul class="footer-links">
          
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="../../../../images/hugo-logo.png" width="22" height="22" alt="hugo"></a>
          </li>
        </ul>
      </footer>

    </div>

    
  
  
  
  <script>
  

  for(h=1; h<=6; ++h) 
  {
    var hs = document.getElementsByTagName('h'+h);
    for(i=0; i<hs.length; ++i)
    {
      
      if(hs[i].id)
      {
        var l = document.createElement("a");
        l.href = "#" + hs[i].id;
        l.innerHTML = "# ";
        l.className = "headinglink";
        hs[i].insertBefore(l, hs[i].firstChild);
      }
    }
  }
  </script>
  
  </body>
  
</html>

